"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("vue"),l=require("element-plus"),a=require("@fast-china/utils"),i=require("@vueuse/core"),r=require("decimal.js"),u=require("lodash-unified"),t=require("../utils/upload.js");exports.useUpload=(o,n,s,d,p)=>{const c=i.useVModel(s,"fileList",d,{passive:!0}),m=e.ref(!1),f=e.inject(l.formContextKey,void 0),g=e.inject(l.formItemContextKey,void 0),v=new r.Decimal(1024),h=new r.Decimal(u.isNumber(p?.maxSize)?p?.maxSize:Number(p?.maxSize)),$=h.div(v);e.onMounted(()=>{p.uploadApi||p.uploadUrl||a.consoleWarn(o,"['uploadApi', 'uploadUrl'] 属性必须二选一。")});const y=()=>{if(c.value.length>0)if(u.isString(s.modelValue))d("update:modelValue",c.value[0].url),d("change",c.value[0].url);else if(s.multiple){const e=c.value.map(e=>e.url);d("update:modelValue",e),d("change",e)}else d("update:modelValue",c.value[0].url),d("change",c.value[0].url);else d("update:modelValue",null),d("change",null)};return e.watch(()=>s.modelValue,e=>{if(e)if(u.isArray(e))c.value=e.map(e=>{const a=c.value.find(l=>l.url===e);return{name:"",status:"success",uid:a?.uid??l.genFileId(),url:e}});else{const a=c.value.find(l=>l.url===e);c.value=[{name:"",status:"success",uid:a?.uid??l.genFileId(),url:e}]}},{immediate:!0}),{fileList:c,loading:m,formContext:f,formItemContext:g,maxSizeMB:$,handleValue:y,handleHttpRequest:async e=>{let i;if(s.data&&(i=t.uploadUtil.getPropsData(e.file,s.data)),!p?.uploadUrl&&!p?.uploadUrl)return l.ElMessage.error(`上传${n}Api或地址不能为空`),void a.consoleError(o,`上传${n}接口 “uploadApi” 或地址 “uploadUrl” 不能为空`);m.value=!0;try{let l;l=p.uploadApi?await t.uploadUtil.uploadFileByApi(p.uploadApi,e.file,e.filename,i):await t.uploadUtil.uploadFile(p.uploadUrl,e.file,e.filename,i),e.onSuccess(l)}finally{m.value=!1}},handleOnSuccess:(e,a,i)=>{e&&(!s.multiple&&i.length>1&&i.shift(),a.url=e,y(),g?.prop&&f?.validateField([g.prop]),l.ElMessage.success("上传成功"),s.onSuccess&&s.onSuccess(e,a,i))},handleOnError:(e,a,i)=>{l.ElNotification({message:`【${a.name}】${n}上传失败，请您重新上传`,type:"error"}),s.onError&&s.onError(e,a,i)},handleOnExceed:(e,a)=>{l.ElMessage.warning(`最多只能上传 ${s.limit} 个${n}，请移除后再进行上传`),s.onExceed&&s.onExceed(e,a)},handleOnUpload:e=>{if(new r.Decimal(e.size).div(v).greaterThan(h))return a.consoleWarn(o,`【${e.name}】${n}上传大小不能超过 ${$.toString()}MB`),l.ElMessage.warning(`【${e.name}】${n}上传大小不能超过 ${$.toString()}MB`),!1;const i="type"in e?e.type:e.raw.type;if(s.accept&&s.accept.split(",").every(e=>e!==i)){const e=t.uploadUtil.detectFileType(s.accept);return a.consoleError(o,`只允许上传【${e}】格式的${n}`),l.ElMessage.error(`只允许上传【${e}】格式的${n}`),!1}return!0}}};
//# sourceMappingURL=useUpload.js.map
