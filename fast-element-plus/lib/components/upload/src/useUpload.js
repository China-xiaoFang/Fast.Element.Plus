"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("vue"),l=require("element-plus"),a=require("@fast-china/utils"),u=require("@vueuse/core"),i=require("decimal.js"),r=require("lodash-unified"),o=require("../utils/upload.js");exports.useUpload=(n,t,s,d,p)=>{const c=u.useVModel(s,"fileList",d,{passive:!0}),m=e.ref(!1),v=e.inject(l.formContextKey,void 0),f=e.inject(l.formItemContextKey,void 0),g=new i.Decimal(1024),h=new i.Decimal(r.isNumber(null==p?void 0:p.maxSize)?null==p?void 0:p.maxSize:Number(null==p?void 0:p.maxSize)),$=h.div(g);e.onMounted(()=>{p.uploadApi||p.uploadUrl||a.consoleWarn(n,"['uploadApi', 'uploadUrl'] 属性必须二选一。")});const y=()=>{if(c.value.length>0)if(r.isString(s.modelValue))d("update:modelValue",c.value[0].url),d("change",c.value[0].url);else if(s.multiple){const e=c.value.map(e=>e.url);d("update:modelValue",e),d("change",e)}else d("update:modelValue",c.value[0].url),d("change",c.value[0].url);else d("update:modelValue",null),d("change",null)};return e.watch(()=>s.modelValue,e=>{if(e)if(r.isArray(e))c.value=e.map(e=>{const a=c.value.find(l=>l.url===e);return{name:"",status:"success",uid:(null==a?void 0:a.uid)??l.genFileId(),url:e}});else{const a=c.value.find(l=>l.url===e);c.value=[{name:"",status:"success",uid:(null==a?void 0:a.uid)??l.genFileId(),url:e}]}},{immediate:!0}),{fileList:c,loading:m,formContext:v,formItemContext:f,maxSizeMB:$,handleValue:y,handleHttpRequest:async e=>{let u;if(s.data&&(u=o.uploadUtil.getPropsData(e.file,s.data)),!(null==p?void 0:p.uploadUrl)&&!(null==p?void 0:p.uploadUrl))return l.ElMessage.error(`上传${t}Api或地址不能为空`),void a.consoleError(n,`上传${t}接口 “uploadApi” 或地址 “uploadUrl” 不能为空`);m.value=!0;try{let l;l=p.uploadApi?await o.uploadUtil.uploadFileByApi(p.uploadApi,e.file,e.filename,u):await o.uploadUtil.uploadFile(p.uploadUrl,e.file,e.filename,u),e.onSuccess(l)}finally{m.value=!1}},handleOnSuccess:(e,a,u)=>{e&&(!s.multiple&&u.length>1&&u.shift(),a.url=e,y(),(null==f?void 0:f.prop)&&(null==v||v.validateField([f.prop])),l.ElMessage.success("上传成功"),s.onSuccess&&s.onSuccess(e,a,u))},handleOnError:(e,a,u)=>{l.ElNotification({message:`【${a.name}】${t}上传失败，请您重新上传`,type:"error"}),s.onError&&s.onError(e,a,u)},handleOnExceed:(e,a)=>{l.ElMessage.warning(`最多只能上传 ${s.limit} 个${t}，请移除后再进行上传`),s.onExceed&&s.onExceed(e,a)},handleOnUpload:e=>{if(new i.Decimal(e.size).div(g).greaterThan(h))return a.consoleWarn(n,`【${e.name}】${t}上传大小不能超过 ${$.toString()}MB`),l.ElMessage.warning(`【${e.name}】${t}上传大小不能超过 ${$.toString()}MB`),!1;const u="type"in e?e.type:e.raw.type;if(s.accept&&s.accept.split(",").every(e=>e!==u)){const e=o.uploadUtil.detectFileType(s.accept);return a.consoleError(n,`只允许上传【${e}】格式的${t}`),l.ElMessage.error(`只允许上传【${e}】格式的${t}`),!1}return!0}}};
//# sourceMappingURL=useUpload.js.map
