{"version":3,"file":"uploadImages.js","sources":["../../../../../packages/components/uploadImages/src/uploadImages.tsx"],"sourcesContent":["import { Fragment, computed, defineComponent, reactive, ref } from \"vue\";\nimport { Delete, Edit, Plus, ZoomIn } from \"@element-plus/icons-vue\";\nimport { useUpload } from \"@fast-element-plus/components/upload/src/useUpload\";\nimport { FaMimeType } from \"@fast-element-plus/constants\";\nimport { FastApp } from \"@fast-element-plus/settings\";\nimport { definePropType, makeSlots, stringUtil, useExpose, useProps, useRender } from \"@fast-element-plus/utils\";\nimport { ElIcon, ElImageViewer, ElUpload, uploadProps } from \"element-plus\";\nimport type { UploadFile, UploadInstance, UploadProps, UploadUserFile, uploadListTypes } from \"element-plus\";\nimport { isArray, isString } from \"lodash-unified\";\n\nexport const faUploadImagesProps = {\n\t...uploadProps,\n\t/** @description accepted [file types](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-accept), will not work when `thumbnail-mode === true` */\n\taccept: {\n\t\ttype: String,\n\t\tdefault: (): string => FaMimeType.Image,\n\t},\n\t/** @description type of file list */\n\tlistType: {\n\t\ttype: definePropType<(typeof uploadListTypes)[number]>(String),\n\t\tdefault: \"picture-card\",\n\t},\n\t/** @description whether uploading multiple files is permitted */\n\tmultiple: {\n\t\ttype: Boolean,\n\t\tdefault: true,\n\t},\n\t/** @description maximum number of uploads allowed */\n\tlimit: {\n\t\ttype: Number,\n\t\tdefault: 9,\n\t},\n\t/** @description v-model绑定值 */\n\tmodelValue: definePropType<string | string[]>([String, Array]),\n\t/** @description 大小限制，单位kb */\n\tmaxSize: {\n\t\ttype: definePropType<string | number>([String, Number]),\n\t\tdefault: 2048,\n\t},\n\t/** @description 图片上传地址 */\n\tuploadUrl: {\n\t\ttype: String,\n\t\tdefault: (): string => FastApp.state.upload.url,\n\t},\n\t/** @description 文件类型 */\n\tfileType: Number,\n};\n\nexport const faUploadImagesEmits = {\n\t/** @description v-model 回调 */\n\t\"update:modelValue\": (value: string | string[]): boolean => isString(value) || isArray(value),\n\t/** @description v-model:fileList 回调 */\n\t\"update:fileList\": (value: UploadUserFile[]): boolean => isArray(value),\n\t/** @description 改变 */\n\tchange: (value: string | string[]): boolean => isString(value) || isArray(value),\n};\n\ntype FaUploadImagesSlots = {\n\t/** @description 默认内容插槽 */\n\tdefault: never;\n};\n\nexport default defineComponent({\n\tname: \"FaUploadImages\",\n\tprops: faUploadImagesProps,\n\temits: faUploadImagesEmits,\n\tslots: makeSlots<FaUploadImagesSlots>(),\n\tsetup(props, { attrs, slots, emit, expose }) {\n\t\tconst {\n\t\t\tfileList,\n\t\t\tloading,\n\t\t\tformContext,\n\t\t\tmaxSizeMB,\n\t\t\thandleValue,\n\t\t\thandleHttpRequest,\n\t\t\thandleOnSuccess,\n\t\t\thandleOnError,\n\t\t\thandleOnExceed,\n\t\t\thandleOnUpload,\n\t\t} = useUpload(\"FaUploadImages\", \"图片\", props, emit, {\n\t\t\tmaxSize: props.maxSize,\n\t\t\tuploadUrl: props.uploadUrl,\n\t\t});\n\n\t\tconst disabled = computed(() => {\n\t\t\treturn props.disabled || formContext?.disabled;\n\t\t});\n\n\t\tconst state = reactive({\n\t\t\tuploadKey: `fa-upload-images__${stringUtil.generateRandomString(8)}`,\n\t\t\tpreview: false,\n\t\t\tpreviewIndex: -1,\n\t\t\tpreviewList: [],\n\t\t});\n\n\t\tconst uploadRef = ref<UploadInstance>();\n\n\t\tconst handleEdit = (): void => {\n\t\t\tconst uploadInputEl = document.querySelector(`.${state.uploadKey} .el-upload__input`);\n\t\t\tuploadInputEl && uploadInputEl.dispatchEvent(new MouseEvent(\"click\"));\n\t\t};\n\n\t\tconst handlePreview = (uploadFile: UploadFile): void => {\n\t\t\tstate.previewIndex = fileList.value.findIndex((f) => f.url === uploadFile.url);\n\t\t\tstate.previewList = fileList.value.map((m) => m.url);\n\t\t\tstate.preview = true;\n\t\t};\n\n\t\tconst handleRemove = (index: number): void => {\n\t\t\tfileList.value.splice(index, 1);\n\t\t\thandleValue();\n\t\t};\n\n\t\tconst handleBeforeUpload: UploadProps[\"beforeUpload\"] = (rawFile) => {\n\t\t\tif (!handleOnUpload(rawFile)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (props.beforeUpload) {\n\t\t\t\treturn props.beforeUpload(rawFile);\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\tconst elUploadProps = useProps(props, uploadProps, [\n\t\t\t\"fileList\",\n\t\t\t\"disabled\",\n\t\t\t\"httpRequest\",\n\t\t\t\"beforeUpload\",\n\t\t\t\"onExceed\",\n\t\t\t\"onSuccess\",\n\t\t\t\"onError\",\n\t\t]);\n\n\t\tuseRender(() => (\n\t\t\t<Fragment>\n\t\t\t\t<ElUpload\n\t\t\t\t\t{...elUploadProps.value}\n\t\t\t\t\tref={uploadRef}\n\t\t\t\t\tclass={[\"fa-upload-images\", state.uploadKey, { \"fa-upload-images__hidden-upload\": fileList.value.length >= props.limit }]}\n\t\t\t\t\tvLoading={loading.value}\n\t\t\t\t\tvModel:fileList={fileList.value}\n\t\t\t\t\tdisabled={disabled.value}\n\t\t\t\t\thttpRequest={handleHttpRequest}\n\t\t\t\t\tbeforeUpload={handleBeforeUpload}\n\t\t\t\t\tonExceed={handleOnExceed}\n\t\t\t\t\tonSuccess={handleOnSuccess}\n\t\t\t\t\tonError={handleOnError}\n\t\t\t\t>\n\t\t\t\t\t{{\n\t\t\t\t\t\tdefault: () =>\n\t\t\t\t\t\t\tfileList.value.length < props.limit && slots.default ? (\n\t\t\t\t\t\t\t\tslots.default()\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t<Plus />\n\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\ttip: () => <div class=\"el-upload__tip\">files with a size less than {maxSizeMB.toString()}MB</div>,\n\t\t\t\t\t\tfile: ({ file, index }: { file: UploadFile; index: number }) => (\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<img class=\"el-upload-list__item-thumbnail\" src={file.url} />\n\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-actions\">\n\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-preview\" onClick={() => handlePreview(file)} title=\"查看\">\n\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t<ZoomIn />\n\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t{!disabled.value && (\n\t\t\t\t\t\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={handleEdit} title=\"编辑\">\n\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Edit />\n\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={() => handleRemove(index)} title=\"删除\">\n\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</Fragment>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t),\n\t\t\t\t\t}}\n\t\t\t\t</ElUpload>\n\t\t\t\t{state.preview ? (\n\t\t\t\t\t<ElImageViewer\n\t\t\t\t\t\tcloseOnPressEscape\n\t\t\t\t\t\thideOnClickModal\n\t\t\t\t\t\tteleported\n\t\t\t\t\t\tonClose={() => (state.preview = false)}\n\t\t\t\t\t\turlList={state.previewList}\n\t\t\t\t\t/>\n\t\t\t\t) : null}\n\t\t\t</Fragment>\n\t\t));\n\n\t\treturn useExpose(expose, {\n\t\t\t...computed(() => ({\n\t\t\t\t/** @description cancel upload request */\n\t\t\t\tabort: uploadRef.value?.abort,\n\t\t\t\t/** @description upload the file list manually */\n\t\t\t\tsubmit: uploadRef.value?.submit,\n\t\t\t\t/** @description clear the file list  */\n\t\t\t\tclearFiles: uploadRef.value?.clearFiles,\n\t\t\t\t/** @description select the file manually */\n\t\t\t\thandleStart: uploadRef.value?.handleStart,\n\t\t\t\t/** @description remove the file manually */\n\t\t\t\thandleRemove: uploadRef.value?.handleRemove,\n\t\t\t})).value,\n\t\t\t/** @description 加载状态 */\n\t\t\tloading,\n\t\t\t/** @description 文件集合 */\n\t\t\tfileList,\n\t\t\t/** @description 预览 */\n\t\t\tpreview: state.preview,\n\t\t\t/** @description 预览集合 */\n\t\t\tpreviewList: state.previewList,\n\t\t});\n\t},\n});\n"],"names":["faUploadImagesProps","uploadProps","accept","type","String","default","FaMimeType","Image","listType","definePropType","multiple","Boolean","limit","Number","modelValue","Array","maxSize","uploadUrl","FastApp","state","upload","url","fileType","faUploadImagesEmits","isString","value","isArray","change","defineComponent","name","props","emits","slots","makeSlots","setup","attrs","emit","expose","fileList","loading","formContext","maxSizeMB","handleValue","handleHttpRequest","handleOnSuccess","handleOnError","handleOnExceed","handleOnUpload","useUpload","disabled","computed","reactive","uploadKey","stringUtil","generateRandomString","preview","previewIndex","previewList","uploadRef","ref","handleEdit","uploadInputEl","document","querySelector","dispatchEvent","MouseEvent","handleBeforeUpload","rawFile","beforeUpload","elUploadProps","useProps","useExpose","useRender","_createVNode","_Fragment","Fragment","_withDirectives","ElUpload","_mergeProps","class","length","$event","httpRequest","onExceed","onSuccess","onError","ElIcon","createVNode","Plus","tip","_createTextVNode","toString","file","index","src","onClick","handlePreview","uploadFile","findIndex","f","map","m","title","ZoomIn","Edit","splice","handleRemove","Delete","_resolveDirective","ElImageViewer","closeOnPressEscape","hideOnClickModal","teleported","onClose","urlList","abort","submit","clearFiles","handleStart"],"mappings":"8nBAUaA,EAAsB,IAC/BC,EAAWA,YAEdC,OAAQ,CACPC,KAAMC,OACNC,QAASA,IAAcC,EAAAA,WAAWC,OAGnCC,SAAU,CACTL,KAAMM,EAAcA,eAAmCL,QACvDC,QAAS,gBAGVK,SAAU,CACTP,KAAMQ,QACNN,SAAS,GAGVO,MAAO,CACNT,KAAMU,OACNR,QAAS,GAGVS,WAAYL,EAAcA,eAAoB,CAACL,OAAQW,QAEvDC,QAAS,CACRb,KAAMM,EAAcA,eAAkB,CAACL,OAAQS,SAC/CR,QAAS,MAGVY,UAAW,CACVd,KAAMC,OACNC,QAASA,IAAca,EAAAA,QAAQC,MAAMC,OAAOC,KAG7CC,SAAUT,QAGEU,EAAsB,CAElC,uBAA4DC,EAAQA,SAACC,IAAUC,EAAAA,QAAQD,GAEvF,kBAAoBA,GAAqCC,EAAOA,QAACD,GAEjEE,UAA+CH,EAAQA,SAACC,IAAUC,EAAAA,QAAQD,IAQ5DG,oBAAgB,CAC9BC,KAAM,iBACNC,MAAO9B,EACP+B,MAAOR,EACPS,MAAOC,EAAAA,YACPC,KAAAA,CAAMJ,GAAOK,MAAEA,EAAOH,MAAAA,EAAAA,KAAOI,EAAMC,OAAAA,IAC5B,MAAAC,SACLA,EAAAA,QACAC,EAAAA,YACAC,EAAAA,UACAC,EAAAA,YACAC,EAAAA,kBACAC,EAAAA,gBACAC,EAAAA,cACAC,EAAAA,eACAC,EAAAA,eACAC,GACGC,EAASA,UAAC,iBAAkB,KAAMlB,EAAOM,EAAM,CAClDpB,QAASc,EAAMd,QACfC,UAAWa,EAAMb,YAGZgC,EAAWC,EAAAA,UAAS,IAClBpB,EAAMmB,WAAyBA,MAAbT,OAAaS,EAAAA,EAAAA,YAGjC9B,EAAQgC,EAAAA,SAAS,CACtBC,UAAW,qBAAqBC,EAAAA,WAAWC,qBAAqB,KAChEC,SAAS,EACTC,cAAc,EACdC,YAAa,KAGRC,EAAYC,EAAAA,MAEZC,EAAaA,KAClB,MAAMC,EAAgBC,SAASC,cAAc,IAAI5C,EAAMiC,+BACvDS,GAAiBA,EAAcG,cAAc,IAAIC,WAAW,SAAQ,EAc/DC,EAA+DC,KAC/DpB,EAAeoB,MAGhBrC,EAAMsC,cACFtC,EAAMsC,aAAaD,IAKtBE,EAAgBC,EAAQA,SAACxC,EAAO7B,EAAAA,YAAa,CAClD,WACA,WACA,cACA,eACA,WACA,YACA,YAoEMsE,OAjEPC,EAAAA,WAAU,IAAAC,EAAAA,YAAAC,EAAAC,eAAAC,iBAAAH,EAAAA,YAAAI,EAAAA,SAAAC,aAGHT,EAAc5C,MAAK,CAAAkC,IAClBD,EAASqB,MACP,CAAC,mBAAoB5D,EAAMiC,UAAW,CAAE,kCAAmCd,EAASb,MAAMuD,QAAUlD,EAAMlB,QAAQ0B,SAExGA,EAASb,MAAK,oBAAda,GAAAA,EAASb,MAAKwD,EAAAhC,SACrBA,EAASxB,MAAKyD,YACXvC,EAAiByB,aAChBF,EAAkBiB,SACtBrC,EAAcsC,UACbxC,EAAeyC,QACjBxC,IAAa,CAGrBxC,QAASA,IACRiC,EAASb,MAAMuD,OAASlD,EAAMlB,OAASoB,EAAM3B,QAC5C2B,EAAM3B,UAASoE,EAAAA,YAAAa,EAAAA,OAAA,KAAA,CAAAjF,QAAAA,IAAAoE,CAAAA,EAAAc,YAAAC,EAAAA,KAAA,KAAA,SAMjBC,IAAKA,IAAAhB,EAAAc,YAAA,MAAA,CAAAR,MAAA,kBAAAW,CAAAA,EAAAA,gDAA+DjD,EAAUkD,WAAUD,EAAAA,gBAAS,QACjGE,KAAMA,EAAGA,OAAMC,MAAAA,KAA4CpB,EAAAc,YAAA,MAAA,KAAA,CAAAd,EAAAA,YAAA,MAAA,CAAAM,MAAA,iCAAAe,IAERF,EAAKvE,KAAG,MAAAoD,EAAAc,YAAA,OAAA,CAAAR,MAAA,gCAAA,CAAAN,EAAAc,YAAA,OAAA,CAAAR,MAAA,+BAAAgB,QAEJA,KAAMC,OA5DTC,EA4DuBL,EA3DxEpC,EAAAA,aAAelB,EAASb,MAAMyE,cAAiBC,EAAE9E,MAAQ4E,EAAW5E,MAC1EF,EAAMsC,YAAcnB,EAASb,MAAM2E,KAAKC,GAAMA,EAAEhF,WAChDF,EAAMoC,SAAU,GAHM0C,IAAiCA,CA4D2B,EAACK,MAAA,MAAA7B,CAAAA,EAAAA,YAAAa,EAAAA,OAAA,KAAA,CAAAjF,QAAAA,IAAAoE,CAAAA,EAAAc,YAAAgB,EAAAA,OAAA,KAAA,YAK3EtD,EAASxB,OAAKgD,cAAAC,EAAAA,SAAA,KAAA,CAAAD,EAAAc,YAAA,OAAA,CAAAR,MAAA,4BAAAgB,QAEmCnC,EAAU0C,MAAA,MAAA7B,CAAAA,EAAAA,YAAAa,EAAAA,OAAA,KAAA,CAAAjF,QAAAA,IAAAoE,CAAAA,EAAAc,YAAAiB,EAAAA,KAAA,KAAA,WAAA/B,EAAAc,YAAA,OAAA,CAAAR,MAAA,4BAAAgB,QAKVA,IAlEpCF,CAAAA,IACZpE,EAAAA,MAAMgF,OAAOZ,EAAO,QAiEkCa,CAAab,GAAMS,MAAA,MAAA7B,CAAAA,EAAAA,YAAAa,EAAAA,OAAA,KAAA,CAAAjF,QAAAA,IAAAoE,CAAAA,EAAAc,YAAAoB,EAAAA,OAAA,KAAA,mBAS9E,CAAA,CAAAC,mBAAA,WA5CQrE,EAAQd,SA+ClBN,EAAMoC,QAAOkB,EAAAA,YAAAoC,EAAAA,cAAA,CAAAC,oBAAA,EAAAC,kBAAA,EAAAC,YAAA,EAAAC,QAKHA,IAAO9F,EAAMoC,SAAU,EAAM2D,QAC7B/F,EAAMsC,aAEb,MAAA,SAICc,EAAAA,UAAUlC,EAAQ,IACrBa,EAAQA,UAAC,mBAAO,MAAA,CAElBiE,MAAOzD,OAAAA,EAAUjC,EAAAA,YAAO0F,EAAAA,EAAAA,MAExBC,OAAQ1D,OAAAA,EAAUjC,EAAAA,YAAO2F,EAAAA,EAAAA,OAEzBC,WAAY3D,OAAAA,EAAUjC,EAAAA,YAAO4F,EAAAA,EAAAA,WAE7BC,YAAa5D,OAAAA,EAAUjC,EAAAA,YAAO6F,EAAAA,EAAAA,YAE9BZ,aAAchD,OAAAA,EAAUjC,EAAAA,YAAOiF,EAAAA,EAAAA,aAC/B,IAAGjF,MAEJc,UAEAD,WAEAiB,QAASpC,EAAMoC,QAEfE,YAAatC,EAAMsC,aAErB"}