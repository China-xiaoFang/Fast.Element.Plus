{"version":3,"file":"uploadImage.js","sources":["../../../../../packages/components/uploadImage/src/uploadImage.tsx"],"sourcesContent":["import { Fragment, computed, defineComponent, reactive, ref, withModifiers } from \"vue\";\nimport { ElIcon, ElImageViewer, ElUpload, uploadProps } from \"element-plus\";\nimport { Delete, Edit, UploadFilled, ZoomIn } from \"@element-plus/icons-vue\";\nimport { useUpload } from \"@fast-element-plus/components/upload/src/useUpload\";\nimport { FaMimeType } from \"@fast-element-plus/constants\";\nimport { addUnit, definePropType, makeSlots, stringUtil, useExpose, useProps, useRender } from \"@fast-china/utils\";\nimport { isArray, isNull, isString } from \"lodash-unified\";\nimport type { UploadInstance, UploadProps, UploadUserFile, uploadListTypes } from \"element-plus\";\n\nexport const faUploadImageProps = {\n\t...uploadProps,\n\t/** @description whether to activate drag and drop mode */\n\tdrag: {\n\t\ttype: Boolean,\n\t\tdefault: true,\n\t},\n\t/** @description accepted [file types](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-accept), will not work when `thumbnail-mode === true` */\n\taccept: {\n\t\ttype: String,\n\t\tdefault: (): string => FaMimeType.Image,\n\t},\n\t/** @description type of file list */\n\tlistType: {\n\t\ttype: definePropType<(typeof uploadListTypes)[number]>(String),\n\t\tdefault: \"picture\",\n\t},\n\t/** @description whether to show the uploaded file list */\n\tshowFileList: {\n\t\ttype: Boolean,\n\t\tdefault: false,\n\t},\n\t/** @description v-model绑定值 */\n\tmodelValue: String,\n\t/** @description 大小限制，单位kb */\n\tmaxSize: {\n\t\ttype: [String, Number],\n\t\tdefault: 2048,\n\t},\n\t/** @description 图片上传接口，优先级最高 */\n\tuploadApi: {\n\t\ttype: definePropType<(formData: FormData) => Promise<string>>(Function),\n\t},\n\t/** @description 图片上传地址 */\n\tuploadUrl: String,\n\t/** @description 宽度 */\n\twidth: {\n\t\ttype: [String, Number],\n\t\tdefault: 150,\n\t},\n\t/** @description 高度 */\n\theight: {\n\t\ttype: [String, Number],\n\t\tdefault: 150,\n\t},\n};\n\nexport const faUploadImageEmits = {\n\t/** @description v-model 回调 */\n\t\"update:modelValue\": (value: string): boolean => isString(value) || isArray(value) || isNull(value),\n\t/** @description v-model:fileList 回调 */\n\t\"update:fileList\": (value: UploadUserFile[]): boolean => isArray(value),\n\t/** @description 改变 */\n\tchange: (value: string): boolean => isString(value) || isArray(value) || isNull(value),\n};\n\ntype FaUploadImageSlots = {\n\t/** @description 默认内容插槽 */\n\tdefault: never;\n};\n\nexport default defineComponent({\n\tname: \"FaUploadImage\",\n\tprops: faUploadImageProps,\n\temits: faUploadImageEmits,\n\tslots: makeSlots<FaUploadImageSlots>(),\n\tsetup(props, { attrs, slots, emit, expose }) {\n\t\tconst {\n\t\t\tfileList,\n\t\t\tloading,\n\t\t\tformContext,\n\t\t\tmaxSizeMB,\n\t\t\thandleValue,\n\t\t\thandleHttpRequest,\n\t\t\thandleOnSuccess,\n\t\t\thandleOnError,\n\t\t\thandleOnExceed,\n\t\t\thandleOnUpload,\n\t\t} = useUpload(\"FaUploadImage\", \"图片\", props, emit, {\n\t\t\tmaxSize: props.maxSize,\n\t\t\tuploadApi: props.uploadApi,\n\t\t\tuploadUrl: props.uploadUrl,\n\t\t});\n\n\t\tconst disabled = computed(() => {\n\t\t\treturn props.disabled || formContext?.disabled;\n\t\t});\n\n\t\tconst state = reactive({\n\t\t\tuploadKey: `fa-upload-image__${stringUtil.generateRandomString(8)}`,\n\t\t\tpreview: false,\n\t\t\tpreviewList: [],\n\t\t});\n\n\t\tconst uploadRef = ref<UploadInstance>();\n\n\t\tconst handleEdit = (): void => {\n\t\t\tconst uploadInputEl = document.querySelector(`.${state.uploadKey} .el-upload__input`);\n\t\t\tuploadInputEl && uploadInputEl.dispatchEvent(new MouseEvent(\"click\"));\n\t\t};\n\n\t\tconst handlePreview = (): void => {\n\t\t\tstate.previewList = [fileList.value[0].url];\n\t\t\tstate.preview = true;\n\t\t};\n\n\t\tconst handleRemove = (): void => {\n\t\t\tfileList.value = [];\n\t\t\thandleValue();\n\t\t};\n\n\t\tconst handleBeforeUpload: UploadProps[\"beforeUpload\"] = (rawFile) => {\n\t\t\tif (!handleOnUpload(rawFile)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (props.beforeUpload) {\n\t\t\t\treturn props.beforeUpload(rawFile);\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\tconst elUploadProps = useProps(props, uploadProps, [\n\t\t\t\"fileList\",\n\t\t\t\"disabled\",\n\t\t\t\"httpRequest\",\n\t\t\t\"beforeUpload\",\n\t\t\t\"onExceed\",\n\t\t\t\"onSuccess\",\n\t\t\t\"onError\",\n\t\t]);\n\n\t\tuseRender(() => (\n\t\t\t<Fragment>\n\t\t\t\t<ElUpload\n\t\t\t\t\t{...elUploadProps.value}\n\t\t\t\t\tref={uploadRef}\n\t\t\t\t\tclass={[\"fa-upload-image\", state.uploadKey]}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\"--width\": addUnit(props.width),\n\t\t\t\t\t\t\"--height\": addUnit(props.height),\n\t\t\t\t\t}}\n\t\t\t\t\tvLoading={loading.value}\n\t\t\t\t\tvModel:fileList={fileList.value}\n\t\t\t\t\tdisabled={disabled.value}\n\t\t\t\t\thttpRequest={handleHttpRequest}\n\t\t\t\t\tbeforeUpload={handleBeforeUpload}\n\t\t\t\t\tonExceed={handleOnExceed}\n\t\t\t\t\tonSuccess={handleOnSuccess}\n\t\t\t\t\tonError={handleOnError}\n\t\t\t\t>\n\t\t\t\t\t{{\n\t\t\t\t\t\tdefault: () =>\n\t\t\t\t\t\t\tfileList.value.length > 0 ? (\n\t\t\t\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t\t\t\t<img class=\"el-upload-list__item-thumbnail\" src={fileList.value[0].url} />\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tclass=\"el-upload-list__item-actions\"\n\t\t\t\t\t\t\t\t\t\tonClick={withModifiers(() => {\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}, [\"stop\"])}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={() => handlePreview()} title=\"查看\">\n\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t<ZoomIn />\n\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t{!disabled.value && (\n\t\t\t\t\t\t\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={handleEdit} title=\"编辑\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Edit />\n\t\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={() => handleRemove()} title=\"删除\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</Fragment>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</Fragment>\n\t\t\t\t\t\t\t) : slots.default ? (\n\t\t\t\t\t\t\t\tslots.default()\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t\t\t\t<ElIcon class=\"el-icon--upload\">\n\t\t\t\t\t\t\t\t\t\t<UploadFilled />\n\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t<div class=\"el-upload__text\">\n\t\t\t\t\t\t\t\t\t\tDrop file here <br />\n\t\t\t\t\t\t\t\t\t\t<em>click to upload</em>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</Fragment>\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\ttip: () => <div class=\"el-upload__tip\">file with a size less than {maxSizeMB.toString()}MB</div>,\n\t\t\t\t\t}}\n\t\t\t\t</ElUpload>\n\t\t\t\t{state.preview && (\n\t\t\t\t\t<ElImageViewer\n\t\t\t\t\t\tcloseOnPressEscape\n\t\t\t\t\t\thideOnClickModal\n\t\t\t\t\t\tteleported\n\t\t\t\t\t\tonClose={() => (state.preview = false)}\n\t\t\t\t\t\turlList={state.previewList}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</Fragment>\n\t\t));\n\n\t\treturn useExpose(expose, {\n\t\t\t/** @description 取消上传请求 */\n\t\t\tabort: computed(() => uploadRef.value?.abort),\n\t\t\t/** @description 手动上传文件列表 */\n\t\t\tsubmit: computed(() => uploadRef.value?.submit),\n\t\t\t/** @description 清空已上传的文件列表（该方法不支持在 before-upload 中调用） */\n\t\t\tclearFiles: computed(() => uploadRef.value?.clearFiles),\n\t\t\t/** @description 手动选择文件 */\n\t\t\thandleStart: computed(() => uploadRef.value?.handleStart),\n\t\t\t/** @description 手动移除文件。 file 和 rawFile 已被合并。 rawFile 将在 v2.2.0 中移除 */\n\t\t\thandleRemove: computed(() => uploadRef.value?.handleRemove),\n\t\t\t/** @description 加载状态 */\n\t\t\tloading,\n\t\t\t/** @description 文件集合 */\n\t\t\tfileList,\n\t\t\t/** @description 预览 */\n\t\t\tpreview: computed(() => state.preview),\n\t\t\t/** @description 预览集合 */\n\t\t\tpreviewList: computed(() => state.previewList),\n\t\t});\n\t},\n});\n"],"names":["faUploadImageProps","uploadProps","drag","type","Boolean","default","accept","String","FaMimeType","Image","listType","definePropType","showFileList","modelValue","maxSize","Number","uploadApi","Function","uploadUrl","width","height","faUploadImageEmits","value","isString","isArray","isNull","change","UploadImage","name","props","emits","slots","makeSlots","setup","attrs","emit","expose","fileList","loading","formContext","maxSizeMB","handleValue","handleHttpRequest","handleOnSuccess","handleOnError","handleOnExceed","handleOnUpload","useUpload","disabled","computed","state","reactive","uploadKey","stringUtil","generateRandomString","preview","previewList","uploadRef","ref","handleEdit","uploadInputEl","document","querySelector","dispatchEvent","MouseEvent","handleBeforeUpload","rawFile","beforeUpload","elUploadProps","useProps","useRender","_createVNode","_Fragment","_withDirectives","ElUpload","_mergeProps","class","style","addUnit","$event","httpRequest","onExceed","onSuccess","onError","length","src","url","onClick","withModifiers","title","ElIcon","ZoomIn","Edit","Delete","UploadFilled","_createTextVNode","tip","toString","_resolveDirective","ElImageViewer","closeOnPressEscape","hideOnClickModal","teleported","onClose","urlList","useExpose","abort","submit","clearFiles","handleStart","handleRemove"],"mappings":"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"}