"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("vue"),a=require("element-plus"),t=require("@fast-china/utils"),r=require("lodash-unified"),o=require("../utils/table.js"),s=require("./table.type.js"),l=Symbol("tableState"),n=Symbol("enumMap");exports.enumMapKey=n,exports.tableStateKey=l,exports.useTable=(i,c,p)=>{const h=a.useGlobalSize(),u=e.ref(),g=e.ref(),d=e.reactive(new Map);e.provide(n,d);const b=e.reactive({loading:!1,loadingText:"加载中...",orgColumns:[],tableColumns:e.computed(()=>b.orgColumns.filter(e=>e.prop&&!e.pureSearch)),searchColumns:e.computed(()=>b.orgColumns.filter(e=>e.pureSearch||e.search).sort((e,a)=>e.search?.order-a.search?.order)),spanColumns:e.computed(()=>[...b.orgColumns.filter(e=>e.spanProp).map(e=>({prop:e?.prop,spanProp:e?.spanProp})),...i.props.span?[{prop:"__table-index",spanProp:i.props.span},{prop:"__table-selection",spanProp:i.props.span},{prop:"__table-operation",spanProp:i.props.span}]:[]]),tableData:[],tableSpanData:e.computed(()=>{if(b.spanColumns?.length>0&&b.tableData?.length>0){const e=[];b.spanColumns.forEach(a=>{e[a.prop]=new Array(b.tableData.length).fill(1,0,1).fill(0,1),e[`${a.prop}-index`]=0});for(let a=1;a<b.tableData.length;a++)b.spanColumns.forEach(t=>{b.tableData[a][t.spanProp]===b.tableData[a-1][t.spanProp]?e[t.prop][e[`${t.prop}-index`]]++:(e[`${t.prop}-index`]=a,e[t.prop][a]=1)});return e}return[]}),tablePagination:{pageIndex:1,pageSize:20,totalRows:0},initParam:{},searchParam:{},searchValueUpdate:"",searchForm:i.searchForm,selected:!1,selectedList:[],selectedListIds:e.computed(()=>b.selectedList.map(e=>r.isFunction(i.rowKey)?i.rowKey(e):e[i.rowKey])),indeterminateSelectedListIds:[],responseConfig:void 0,operationColumnWidth:e.computed(()=>{const e=b.autoColumnWidth.find(e=>"__table-operation"===e.prop);if(e)return`${e.width}px`;switch(h.value){case"large":case"default":return"54px";case"small":return"42px";default:return"auto"}}),imagePreview:!1,previewList:[],tableWidth:void 0,tableHeight:void 0,autoColumnWidth:[]});e.provide(l,b);const m=()=>{b.loading=!0,b.loadingText="加载中...",b.autoColumnWidth=[];const a=b.tableColumns.filter(e=>e.autoWidth);if(c?.operation&&a.push({prop:"__table-operation"}),a?.length>0){const t="default"===h.value?25:17;e.nextTick(()=>{const e=document.querySelector(`.fa-table__${i.tableKey}`);e&&a.forEach(a=>{const r=e.querySelector(`.__fa-table__auto-width-column__cell-header__${a?.prop}`),o=e.querySelectorAll(`.__fa-table__auto-width-column__cell__${a?.prop}`);let s=0;r&&(s=Math.ceil(r.scrollWidth)+t,a?.sortable&&(s+=24)),o.forEach(e=>{const a=Math.ceil(e.scrollWidth)+t;a>s&&(s=a)});const l=b.autoColumnWidth.find(e=>e.prop===a?.prop);l?l.width=Math.max(l.width,s):b.autoColumnWidth.push({prop:a?.prop,width:s})})})}b.loading=!1},P=e=>{if(i.treeData){const a=[];return e.forEach(e=>{const t=e[i.props.children];r.isArray(t)?t.forEach(t=>a.push({...e,...t})):a.push({...e,...t||{}})}),a}return e},f=()=>{const e={...b.searchParam,...i.pagination?b.tablePagination:{}};return delete e.totalRows,e},C=async()=>{if(b.loading=!0,b.loadingText="加载中...",i.requestApi){const a=f();p("refresh",a);let r=[];try{const e=await i.requestApi(a);if(i.dataCallback&&i.dataCallback(e),i.pagination){const a=e;r=a.rows,Object.assign(b.tablePagination,{pageIndex:a.pageIndex,pageSize:a.pageSize,totalRows:a.totalRows})}else r=e,Object.assign(b.tablePagination,{pageIndex:1,pageSize:0,totalRows:r.length});b.tableData=P(r)}catch(e){t.consoleError("FaTable",e),b.tableData=[]}finally{b.loading=!1}}else{p("refresh",{searchValue:b.searchParam.searchValue});let e=P(i.data);if(e=e.filter(e=>!b.searchParam.searchValue||b.tableColumns.some(a=>e[a.prop]?.toString()?.toLowerCase().includes(b.searchParam.searchValue?.toLowerCase()))),b.searchParam.sortList?.length>0&&(e=e.sort(o.tableUtil.arrayDynamicSort(b.searchParam.sortList))),i.pagination){Object.assign(b.tablePagination,{totalRows:e.length});const a=(b.tablePagination.pageIndex-1)*b.tablePagination.pageSize,t=a+b.tablePagination.pageSize;b.tableData=e.slice(a,t)}else b.tableData=e,Object.assign(b.tablePagination,{pageIndex:1,pageSize:0,totalRows:e.length});b.loading=!1}m()},w=()=>{let e=i.columns?i.columns:[];e.forEach(e=>{(e.pureSearch||e.search)&&(e.search.key??=e.prop,e.search.label??=e.label,e.search.defaultValue&&(b.searchParam[e.search.key]=e.search.defaultValue))}),e=e.sort((e,a)=>e?.order-a?.order),b.orgColumns=o.tableUtil.flatColumns(e,d)},D=()=>{if(i.hideSearchTime)b.searchParam.searchTimeList=void 0;else{const e=new Date,t=new Date;if(i.futureSearchTime)switch(i.dataSearchRange){case"Past1D":e.setDate(e.getDate()+1);break;case"Past3D":e.setDate(e.getDate()+3);break;case"Past1W":e.setDate(e.getDate()+7);break;case"Past1M":e.setMonth(e.getMonth()+1);break;case"Past3M":e.setMonth(e.getMonth()+3);break;case"Past6M":e.setMonth(e.getMonth()+6);break;case"Past1Y":e.setFullYear(e.getFullYear()+1);break;case"Past3Y":e.setFullYear(e.getFullYear()+3)}else switch(i.dataSearchRange){case"Past1D":t.setDate(t.getDate()-1);break;case"Past3D":t.setDate(t.getDate()-3);break;case"Past1W":t.setDate(t.getDate()-7);break;case"Past1M":t.setMonth(t.getMonth()-1);break;case"Past3M":t.setMonth(t.getMonth()-3);break;case"Past6M":t.setMonth(t.getMonth()-6);break;case"Past1Y":t.setFullYear(t.getFullYear()-1);break;case"Past3Y":t.setFullYear(t.getFullYear()-3)}b.searchParam.searchTimeList=[a.dayjs(t).format("YYYY-MM-DD 00:00:00"),a.dayjs(e).format("YYYY-MM-DD 23:59:59")]}},S=async()=>{b.tablePagination.pageIndex=1,(()=>{const e={};for(const a in b.searchParam)b.searchParam[a]||!1===b.searchParam[a]||0===b.searchParam[a]?e[a]=b.searchParam[a]:b.searchParam[a]||delete b.searchParam[a];Object.assign(b.searchParam,e)})(),await C()},y=async()=>{b.orgColumns=[],b.autoColumnWidth=[],b.tableData=[],await t.clickUtil.debounceAsync(async()=>{w(),await S()},300)};return e.watch(()=>i.tableKey,async()=>{await y()}),e.watch(()=>i.searchForm,e=>{b.searchForm=e}),{_globalSize:h,state:b,elementRef:u,tableRef:g,handleTableColumnAutoWidth:m,getRequestParam:f,loadTableColumns:w,handleSizeChange:e=>{b.tablePagination.pageIndex=1,b.tablePagination.pageSize=e,p("sizeChange",e),p("paginationChange",1,e),C()},handlePaginationChange:e=>{b.tablePagination.pageIndex=e,p("sizeChange",b.tablePagination.pageSize),p("paginationChange",e,b.tablePagination.pageSize),C()},defaultSearchTime:D,tableSearch:S,tableReset:async()=>{b.tablePagination.pageIndex=1,b.searchParam={},D(),Object.keys(b.initParam??{}).forEach(e=>{b.searchParam[e]=b.initParam[e]}),p("reset",b.searchParam),await C()},doRender:y,doLoading:(e,a="加载中...")=>{b.loading=!0,b.loadingText=a,t.execFunction(e).then().catch(e=>{t.consoleError("FaTable",e)}).finally(()=>{b.loading=!1})},handleCustomCellClick:(e,{row:a,column:t,$index:r})=>{p("customCellClick",e,{row:a,column:t,$index:r,...s.getTableDefaultSlots(b)})}}};
//# sourceMappingURL=useTable.js.map
