"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("vue"),e=require("element-plus"),t=require("@fast-china/utils"),o=require("lodash-unified"),l=require("../utils/table.js"),r=require("./table.type.js"),n=Symbol("tableState"),s=Symbol("enumMap");exports.enumMapKey=s,exports.tableStateKey=n,exports.useTable=(i,c,p)=>{const u=e.useGlobalSize(),d=a.ref(),h=a.ref(),g=a.reactive(new Map);a.provide(s,g);const m=a.reactive({loading:!1,loadingText:"加载中...",orgColumns:[],tableColumns:a.computed(()=>m.orgColumns.filter(a=>a.prop&&!a.pureSearch)),searchColumns:a.computed(()=>m.orgColumns.filter(a=>a.pureSearch||a.search).sort((a,e)=>{var t,o;return(null==(t=a.search)?void 0:t.order)-(null==(o=e.search)?void 0:o.order)})),spanColumns:a.computed(()=>[...m.orgColumns.filter(a=>a.spanProp).map(a=>({prop:null==a?void 0:a.prop,spanProp:null==a?void 0:a.spanProp})),...i.props.span?[{prop:"__table-index",spanProp:i.props.span},{prop:"__table-selection",spanProp:i.props.span},{prop:"__table-operation",spanProp:i.props.span}]:[]]),tableData:[],tableSpanData:a.computed(()=>{var a,e;if((null==(a=m.spanColumns)?void 0:a.length)>0&&(null==(e=m.tableData)?void 0:e.length)>0){const a=[];m.spanColumns.forEach(e=>{a[e.prop]=new Array(m.tableData.length).fill(1,0,1).fill(0,1),a[`${e.prop}-index`]=0});for(let e=1;e<m.tableData.length;e++)m.spanColumns.forEach(t=>{m.tableData[e][t.spanProp]===m.tableData[e-1][t.spanProp]?a[t.prop][a[`${t.prop}-index`]]++:(a[`${t.prop}-index`]=e,a[t.prop][e]=1)});return a}return[]}),tablePagination:{pageIndex:1,pageSize:20,totalRows:0},initParam:{},searchParam:{},searchValueUpdate:"",showSearch:i.showSearch,hideImage:a.computed(()=>i.hideImage),selected:!1,selectedList:[],selectedListIds:a.computed(()=>m.selectedList.map(a=>o.isFunction(i.rowKey)?i.rowKey(a):a[i.rowKey])),indeterminateSelectedListIds:[],responseConfig:void 0,operationColumnWidth:a.computed(()=>{const a=m.autoColumnWidth.find(a=>"__table-operation"===a.prop);if(a)return`${a.width}px`;switch(u.value){case"large":case"default":return"54px";case"small":return"42px";default:return"auto"}}),imagePreview:!1,previewList:[],tableWidth:void 0,tableHeight:void 0,autoColumnWidth:[]});a.provide(n,m);const b=()=>{m.loading=!0,m.loadingText="加载中...",m.autoColumnWidth=[];const e=m.tableColumns.filter(a=>a.autoWidth);if((null==c?void 0:c.operation)&&e.push({prop:"__table-operation"}),(null==e?void 0:e.length)>0){const t="default"===u.value?25:17;a.nextTick(()=>{const a=document.querySelector(`.fa-table__${i.tableKey}`);a&&e.forEach(e=>{const o=a.querySelector(`.__fa-table__auto-width-column__cell-header__${null==e?void 0:e.prop}`),l=a.querySelectorAll(`.__fa-table__auto-width-column__cell__${null==e?void 0:e.prop}`);let r=0;o&&(r=Math.ceil(o.scrollWidth)+t,(null==e?void 0:e.sortable)&&(r+=24)),l.forEach(a=>{const e=Math.ceil(a.scrollWidth)+t;e>r&&(r=e)});const n=m.autoColumnWidth.find(a=>a.prop===(null==e?void 0:e.prop));n?n.width=Math.max(n.width,r):m.autoColumnWidth.push({prop:null==e?void 0:e.prop,width:r})})})}m.loading=!1},P=a=>{if(i.treeData){const e=[];return a.forEach(a=>{const t=a[i.props.children];o.isArray(t)?t.forEach(t=>e.push({...a,...t})):e.push({...a,...t||{}})}),e}return a},f=()=>{const a={...m.searchParam,...i.pagination?m.tablePagination:{}};return delete a.totalRows,a},w=async()=>{var a;if(m.loading=!0,m.loadingText="加载中...",i.requestApi){const a=f();p("refresh",a);let o=[];try{const e=await i.requestApi(a);if(i.dataCallback&&i.dataCallback(e),i.pagination){const a=e;o=a.rows,Object.assign(m.tablePagination,{pageIndex:a.pageIndex,pageSize:a.pageSize,totalRows:a.totalRows})}else o=e,Object.assign(m.tablePagination,{pageIndex:1,pageSize:0,totalRows:o.length});m.tableData=P(o)}catch(e){t.consoleError("FaTable",e),m.tableData=[]}finally{m.loading=!1}}else{p("refresh",{searchValue:m.searchParam.searchValue});let e=P(i.data);if(e=e.filter(a=>!m.searchParam.searchValue||m.tableColumns.some(e=>{var t,o,l;return null==(l=null==(t=a[e.prop])?void 0:t.toString())?void 0:l.toLowerCase().includes(null==(o=m.searchParam.searchValue)?void 0:o.toLowerCase())})),(null==(a=m.searchParam.sortList)?void 0:a.length)>0&&(e=e.sort(l.tableUtil.arrayDynamicSort(m.searchParam.sortList))),i.pagination){Object.assign(m.tablePagination,{totalRows:e.length});const a=(m.tablePagination.pageIndex-1)*m.tablePagination.pageSize,t=a+m.tablePagination.pageSize;m.tableData=e.slice(a,t)}else m.tableData=e,Object.assign(m.tablePagination,{pageIndex:1,pageSize:0,totalRows:e.length});m.loading=!1}b()},C=()=>{let a=i.columns;a.forEach(a=>{var e,t;(a.pureSearch||a.search)&&((e=a.search).key??(e.key=a.prop),(t=a.search).label??(t.label=a.label),a.search.defaultValue&&(m.searchParam[a.search.key]=a.search.defaultValue))}),a=a.sort((a,e)=>(null==a?void 0:a.order)-(null==e?void 0:e.order)),m.orgColumns=l.tableUtil.flatColumns(a,g)},v=()=>{if(i.hideSearchTime)m.searchParam.searchTimeList=void 0;else{const a=new Date,t=new Date;switch(i.dataSearchRange){case"Past1D":t.setDate(t.getDate()-1);break;case"Past3D":t.setDate(t.getDate()-3);break;case"Past1W":t.setDate(t.getDate()-7);break;case"Past1M":t.setMonth(t.getMonth()-1);break;case"Past3M":t.setMonth(t.getMonth()-3);break;case"Past6M":t.setMonth(t.getMonth()-6);break;case"Past1Y":t.setFullYear(t.getFullYear()-1);break;case"Past3Y":t.setFullYear(t.getFullYear()-3)}m.searchParam.searchTimeList=[e.dayjs(t).format("YYYY-MM-DD 00:00:00"),e.dayjs(a).format("YYYY-MM-DD 23:59:59")]}},S=async()=>{m.tablePagination.pageIndex=1,(()=>{const a={};for(const e in m.searchParam)m.searchParam[e]||!1===m.searchParam[e]||0===m.searchParam[e]?a[e]=m.searchParam[e]:m.searchParam[e]||delete m.searchParam[e];Object.assign(m.searchParam,a)})(),await w()},y=async()=>{m.orgColumns=[],m.autoColumnWidth=[],m.tableData=[],await t.clickUtil.debounceAsync(async()=>{C(),await S()},300)};return a.watch(()=>i.tableKey,async()=>{await y()}),a.watch(()=>i.showSearch,a=>{m.showSearch=a}),{_globalSize:u,state:m,elementRef:d,tableRef:h,handleTableColumnAutoWidth:b,getRequestParam:f,loadTableColumns:C,handleSizeChange:a=>{m.tablePagination.pageIndex=1,m.tablePagination.pageSize=a,p("sizeChange",a),p("paginationChange",1,a),w()},handlePaginationChange:a=>{m.tablePagination.pageIndex=a,p("sizeChange",m.tablePagination.pageSize),p("paginationChange",a,m.tablePagination.pageSize),w()},defaultSearchTime:v,tableSearch:S,tableReset:async()=>{m.tablePagination.pageIndex=1,m.searchParam={},v(),Object.keys(m.initParam??{}).forEach(a=>{m.searchParam[a]=m.initParam[a]}),p("reset",m.searchParam),await w()},doRender:y,doLoading:(a,e="加载中...")=>{m.loading=!0,m.loadingText=e,t.execFunction(a).then().catch(a=>{t.consoleError("FaTable",a)}).finally(()=>{m.loading=!1})},handleCustomCellClick:(a,{row:e,column:t,$index:o})=>{p("customCellClick",a,{row:e,column:t,$index:o,...r.getTableDefaultSlots(m)})}}};
//# sourceMappingURL=useTable.js.map
