"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("vue"),e=require("element-plus"),t=require("@fast-china/utils"),r=require("lodash-unified"),o=require("../utils/table.js"),n=require("./table.type.js"),l=Symbol("tableState"),s=Symbol("enumMap");exports.enumMapKey=s,exports.tableStateKey=l,exports.useTable=(i,c,p)=>{const h=e.useGlobalSize(),u=a.ref(),d=a.ref(),g=a.reactive(new Map);a.provide(s,g);const m=a.reactive({loading:!1,loadingText:"加载中...",orgColumns:[],tableColumns:a.computed(()=>m.orgColumns.filter(a=>a.prop&&!a.pureSearch)),searchColumns:a.computed(()=>m.orgColumns.filter(a=>a.pureSearch||a.search).sort((a,e)=>a.search?.order-e.search?.order)),spanColumns:a.computed(()=>[...m.orgColumns.filter(a=>a.spanProp).map(a=>({prop:a?.prop,spanProp:a?.spanProp})),...i.props.span?[{prop:"__table-index",spanProp:i.props.span},{prop:"__table-selection",spanProp:i.props.span},{prop:"__table-operation",spanProp:i.props.span}]:[]]),tableData:[],tableSpanData:a.computed(()=>{if(m.spanColumns?.length>0&&m.tableData?.length>0){const a=[];m.spanColumns.forEach(e=>{a[e.prop]=new Array(m.tableData.length).fill(1,0,1).fill(0,1),a[`${e.prop}-index`]=0});for(let e=1;e<m.tableData.length;e++)m.spanColumns.forEach(t=>{m.tableData[e][t.spanProp]===m.tableData[e-1][t.spanProp]?a[t.prop][a[`${t.prop}-index`]]++:(a[`${t.prop}-index`]=e,a[t.prop][e]=1)});return a}return[]}),tablePagination:{pageIndex:1,pageSize:20,totalRows:0},initParam:{},searchParam:{},searchValueUpdate:"",showSearch:i.showSearch,hideImage:a.computed(()=>i.hideImage),selected:!1,selectedList:[],selectedListIds:a.computed(()=>m.selectedList.map(a=>r.isFunction(i.rowKey)?i.rowKey(a):a[i.rowKey])),indeterminateSelectedListIds:[],responseConfig:void 0,operationColumnWidth:a.computed(()=>{const a=m.autoColumnWidth.find(a=>"__table-operation"===a.prop);if(a)return`${a.width}px`;switch(h.value){case"large":case"default":return"54px";case"small":return"42px";default:return"auto"}}),imagePreview:!1,previewList:[],tableWidth:void 0,tableHeight:void 0,autoColumnWidth:[]});a.provide(l,m);const b=()=>{m.loading=!0,m.loadingText="加载中...",m.autoColumnWidth=[];const e=m.tableColumns.filter(a=>a.autoWidth);if(c?.operation&&e.push({prop:"__table-operation"}),e?.length>0){const t="default"===h.value?25:17;a.nextTick(()=>{const a=document.querySelector(`.fa-table__${i.tableKey}`);a&&e.forEach(e=>{const r=a.querySelector(`.__fa-table__auto-width-column__cell-header__${e?.prop}`),o=a.querySelectorAll(`.__fa-table__auto-width-column__cell__${e?.prop}`);let n=0;r&&(n=Math.ceil(r.scrollWidth)+t,e?.sortable&&(n+=24)),o.forEach(a=>{const e=Math.ceil(a.scrollWidth)+t;e>n&&(n=e)});const l=m.autoColumnWidth.find(a=>a.prop===e?.prop);l?l.width=Math.max(l.width,n):m.autoColumnWidth.push({prop:e?.prop,width:n})})})}m.loading=!1},P=a=>{if(i.treeData){const e=[];return a.forEach(a=>{const t=a[i.props.children];r.isArray(t)?t.forEach(t=>e.push({...a,...t})):e.push({...a,...t||{}})}),e}return a},f=()=>{const a={...m.searchParam,...i.pagination?m.tablePagination:{}};return delete a.totalRows,a},w=async()=>{if(m.loading=!0,m.loadingText="加载中...",i.requestApi){const e=f();p("refresh",e);let r=[];try{const a=await i.requestApi(e);if(i.dataCallback&&i.dataCallback(a),i.pagination){const e=a;r=e.rows,Object.assign(m.tablePagination,{pageIndex:e.pageIndex,pageSize:e.pageSize,totalRows:e.totalRows})}else r=a,Object.assign(m.tablePagination,{pageIndex:1,pageSize:0,totalRows:r.length});m.tableData=P(r)}catch(a){t.consoleError("FaTable",a),m.tableData=[]}finally{m.loading=!1}}else{p("refresh",{searchValue:m.searchParam.searchValue});let a=P(i.data);if(a=a.filter(a=>!m.searchParam.searchValue||m.tableColumns.some(e=>a[e.prop]?.toString()?.toLowerCase().includes(m.searchParam.searchValue?.toLowerCase()))),m.searchParam.sortList?.length>0&&(a=a.sort(o.tableUtil.arrayDynamicSort(m.searchParam.sortList))),i.pagination){Object.assign(m.tablePagination,{totalRows:a.length});const e=(m.tablePagination.pageIndex-1)*m.tablePagination.pageSize,t=e+m.tablePagination.pageSize;m.tableData=a.slice(e,t)}else m.tableData=a,Object.assign(m.tablePagination,{pageIndex:1,pageSize:0,totalRows:a.length});m.loading=!1}b()},C=()=>{let a=i.columns;a.forEach(a=>{(a.pureSearch||a.search)&&(a.search.key??=a.prop,a.search.label??=a.label,a.search.defaultValue&&(m.searchParam[a.search.key]=a.search.defaultValue))}),a=a.sort((a,e)=>a?.order-e?.order),m.orgColumns=o.tableUtil.flatColumns(a,g)},S=()=>{if(i.hideSearchTime)m.searchParam.searchTimeList=void 0;else{const a=new Date,t=new Date;switch(i.dataSearchRange){case"Past1D":t.setDate(t.getDate()-1);break;case"Past3D":t.setDate(t.getDate()-3);break;case"Past1W":t.setDate(t.getDate()-7);break;case"Past1M":t.setMonth(t.getMonth()-1);break;case"Past3M":t.setMonth(t.getMonth()-3);break;case"Past6M":t.setMonth(t.getMonth()-6);break;case"Past1Y":t.setFullYear(t.getFullYear()-1);break;case"Past3Y":t.setFullYear(t.getFullYear()-3)}m.searchParam.searchTimeList=[e.dayjs(t).format("YYYY-MM-DD 00:00:00"),e.dayjs(a).format("YYYY-MM-DD 23:59:59")]}},y=async()=>{m.tablePagination.pageIndex=1,(()=>{const a={};for(const e in m.searchParam)m.searchParam[e]||!1===m.searchParam[e]||0===m.searchParam[e]?a[e]=m.searchParam[e]:m.searchParam[e]||delete m.searchParam[e];Object.assign(m.searchParam,a)})(),await w()},x=async()=>{m.orgColumns=[],m.autoColumnWidth=[],m.tableData=[],await t.clickUtil.debounceAsync(async()=>{C(),await y()},300)};return a.watch(()=>i.tableKey,async()=>{await x()}),a.watch(()=>i.showSearch,a=>{m.showSearch=a}),{_globalSize:h,state:m,elementRef:u,tableRef:d,handleTableColumnAutoWidth:b,getRequestParam:f,loadTableColumns:C,handleSizeChange:a=>{m.tablePagination.pageIndex=1,m.tablePagination.pageSize=a,p("sizeChange",a),p("paginationChange",1,a),w()},handlePaginationChange:a=>{m.tablePagination.pageIndex=a,p("sizeChange",m.tablePagination.pageSize),p("paginationChange",a,m.tablePagination.pageSize),w()},defaultSearchTime:S,tableSearch:y,tableReset:async()=>{m.tablePagination.pageIndex=1,m.searchParam={},S(),Object.keys(m.initParam??{}).forEach(a=>{m.searchParam[a]=m.initParam[a]}),p("reset",m.searchParam),await w()},doRender:x,doLoading:(a,e="加载中...")=>{m.loading=!0,m.loadingText=e,t.execFunction(a).then().catch(a=>{t.consoleError("FaTable",a)}).finally(()=>{m.loading=!1})},handleCustomCellClick:(a,{row:e,column:t,$index:r})=>{p("customCellClick",a,{row:e,column:t,$index:r,...n.getTableDefaultSlots(m)})}}};
//# sourceMappingURL=useTable.js.map
