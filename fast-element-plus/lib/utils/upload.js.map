{"version":3,"file":"upload.js","sources":["../../../packages/utils/upload.ts"],"sourcesContent":["import { FaMimeType } from \"@fast-element-plus/constants\";\nimport type { ApiResponse } from \"@fast-element-plus/utils\";\nimport { axiosUtil, consoleError } from \"@fast-element-plus/utils\";\nimport type { UploadRawFile } from \"element-plus\";\nimport { ElMessage } from \"element-plus\";\nimport { isArray, isFunction } from \"lodash-unified\";\n\nconst FaMimeTypeNames: Record<string, keyof typeof FaMimeType> = {};\n\nfor (const [kName, vAccept] of Object.entries(FaMimeType)) {\n\tvAccept.split(\",\").forEach((tItem) => {\n\t\tFaMimeTypeNames[tItem.trim()] = kName as keyof typeof FaMimeType;\n\t});\n}\n\n/**\n * 上传工具类\n */\nexport const uploadUtil = {\n\t/**\n\t * 识别文件类型\n\t */\n\tdetectFileType(accept: string): string {\n\t\tconst detectTypes = new Set<string>();\n\t\taccept.split(\",\").forEach((mimeType) => {\n\t\t\tdetectTypes.add(FaMimeTypeNames[mimeType] ?? mimeType);\n\t\t});\n\t\treturn Array.from(detectTypes).join(\",\");\n\t},\n\t/**\n\t * 获取props data属性值\n\t */\n\tgetPropsData(rawFile: UploadRawFile, data: any | any[] | ((rawFile: UploadRawFile) => any[])): any {\n\t\tlet propsData;\n\t\tif (isFunction(data)) {\n\t\t\tpropsData = data(rawFile);\n\t\t} else {\n\t\t\tpropsData = data;\n\t\t}\n\n\t\tconst result = {};\n\t\tif (isArray(data)) {\n\t\t\tdata.forEach((item) => {\n\t\t\t\tObject.assign(result, item);\n\t\t\t});\n\t\t} else {\n\t\t\tObject.assign(result, propsData);\n\t\t}\n\n\t\treturn result;\n\t},\n\t/**\n\t * 文件上传\n\t * @param url 地址\n\t * @param file 文件\n\t * @param fileName 文件名称\n\t * @param fileType 文件类型\n\t * @param params 参数\n\t */\n\tasync uploadFile(url: string, file: File, fileName: string, params?: Record<string, any>): Promise<string | void> {\n\t\tif (!url) {\n\t\t\tconsoleError(\"uploadUtil\", \"文件上传地址为空！\");\n\t\t\tElMessage.error(\"文件上传地址为空！\");\n\t\t\treturn Promise.reject();\n\t\t}\n\t\tconst formData = new FormData();\n\t\tformData.append(\"file\", file);\n\t\tformData.append(\"fileName\", fileName);\n\t\tif (params) {\n\t\t\tObject.keys(params).forEach((key) => {\n\t\t\t\tformData.append(key, params[key]);\n\t\t\t});\n\t\t}\n\t\ttry {\n\t\t\tconst apiRes = await axiosUtil.request<FormData, ApiResponse<string>>({\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"multipart/form-data\",\n\t\t\t\t},\n\t\t\t\turl,\n\t\t\t\tmethod: \"post\",\n\t\t\t\tdata: formData,\n\t\t\t\tcancelDuplicateRequest: false,\n\t\t\t});\n\t\t\treturn Promise.resolve<string>(apiRes.data);\n\t\t} catch (error) {\n\t\t\tconsoleError(\"uploadUtil\", \"文件上传失败！\", error);\n\t\t\tElMessage.error(\"文件上传失败！\");\n\t\t\treturn Promise.reject();\n\t\t}\n\t},\n};\n"],"names":["FaMimeTypeNames","kName","vAccept","Object","entries","FaMimeType","split","forEach","tItem","trim","uploadUtil","detectFileType","accept","detectTypes","Set","mimeType","add","Array","from","join","getPropsData","rawFile","data","propsData","isFunction","result","isArray","item","assign","uploadFile","url","file","fileName","params","error","Promise","reject","formData","FormData","append","keys","key","apiRes","axiosUtil","request","headers","method","cancelDuplicateRequest","resolve","consoleError"],"mappings":"uRAOMA,EAA2D,CAAA,EAEjE,IAAW,MAACC,EAAOC,KAAYC,OAAOC,QAAQC,EAAAA,YAC7CH,EAAQI,MAAM,KAAKC,SAASC,IACXR,EAAAQ,EAAMC,QAAUR,CAAA,IAO3B,MAAMS,EAAa,CAIzB,cAAAC,CAAeC,GACR,MAAAC,MAAkBC,IAIxB,OAHAF,EAAON,MAAM,KAAKC,SAASQ,IAC1BF,EAAYG,IAAIhB,EAAgBe,IAAaA,EAAQ,IAE/CE,MAAMC,KAAKL,GAAaM,KAAK,IACrC,EAIA,YAAAC,CAAaC,EAAwBC,GAChC,IAAAC,EAEHA,EADGC,EAAAA,WAAWF,GACFA,EAAKD,GAELC,EAGb,MAAMG,EAAS,CAAA,EASR,OARHC,EAAAA,QAAQJ,GACNA,EAAAf,SAASoB,IACNxB,OAAAyB,OAAOH,EAAQE,EAAI,IAGpBxB,OAAAyB,OAAOH,EAAQF,GAGhBE,CACR,EASA,gBAAMI,CAAWC,EAAaC,EAAYC,EAAkBC,GAC3D,IAAKH,EAGJ,sBAFa,aAAc,yBACjBI,MAAM,aACTC,QAAQC,SAEV,MAAAC,EAAW,IAAIC,SACZD,EAAAE,OAAO,OAAQR,GACfM,EAAAE,OAAO,WAAYP,GACxBC,GACH9B,OAAOqC,KAAKP,GAAQ1B,SAASkC,IAC5BJ,EAASE,OAAOE,EAAKR,EAAOQ,GAAI,IAG9B,IACG,MAAAC,QAAeC,EAAAA,UAAUC,QAAuC,CACrEC,QAAS,CACR,eAAgB,uBAEjBf,MACAgB,OAAQ,OACRxB,KAAMe,EACNU,wBAAwB,IAElB,OAAAZ,QAAQa,QAAgBN,EAAOpB,YAC9BY,GAGR,OAFae,EAAAA,aAAA,aAAc,UAAWf,eAC5BA,MAAM,WACTC,QAAQC,QAChB,CACD"}