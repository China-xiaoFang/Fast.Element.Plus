{"version":3,"file":"uploadImages.mjs","sources":["../../../../../packages/components/uploadImages/src/uploadImages.tsx"],"sourcesContent":["import { Fragment, computed, defineComponent, reactive, ref } from \"vue\";\nimport { ElIcon, ElImageViewer, ElUpload, uploadProps } from \"element-plus\";\nimport { Delete, Edit, Plus, ZoomIn } from \"@element-plus/icons-vue\";\nimport { useUpload } from \"@fast-element-plus/components/upload/src/useUpload\";\nimport { FaMimeType } from \"@fast-element-plus/constants\";\nimport { definePropType, makeSlots, stringUtil, useExpose, useProps, useRender } from \"@fast-china/utils\";\nimport { isArray, isNull, isString } from \"lodash-unified\";\nimport type { UploadFile, UploadInstance, UploadProps, UploadUserFile, uploadListTypes } from \"element-plus\";\n\nexport const faUploadImagesProps = {\n\t...uploadProps,\n\t/** @description accepted [file types](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-accept), will not work when `thumbnail-mode === true` */\n\taccept: {\n\t\ttype: String,\n\t\tdefault: (): string => FaMimeType.Image,\n\t},\n\t/** @description type of file list */\n\tlistType: {\n\t\ttype: definePropType<(typeof uploadListTypes)[number]>(String),\n\t\tdefault: \"picture-card\",\n\t},\n\t/** @description whether uploading multiple files is permitted */\n\tmultiple: {\n\t\ttype: Boolean,\n\t\tdefault: true,\n\t},\n\t/** @description maximum number of uploads allowed */\n\tlimit: {\n\t\ttype: Number,\n\t\tdefault: 9,\n\t},\n\t/** @description v-model绑定值 */\n\tmodelValue: definePropType<string | string[]>([String, Array]),\n\t/** @description 大小限制，单位kb */\n\tmaxSize: {\n\t\ttype: [String, Number],\n\t\tdefault: 2048,\n\t},\n\t/** @description 图片上传接口，优先级最高 */\n\tuploadApi: {\n\t\ttype: definePropType<(formData: FormData) => Promise<string>>(Function),\n\t},\n\t/** @description 图片上传地址 */\n\tuploadUrl: String,\n};\n\nexport const faUploadImagesEmits = {\n\t/** @description v-model 回调 */\n\t\"update:modelValue\": (value: string | string[]): boolean => isString(value) || isArray(value) || isNull(value),\n\t/** @description v-model:fileList 回调 */\n\t\"update:fileList\": (value: UploadUserFile[]): boolean => isArray(value),\n\t/** @description 改变 */\n\tchange: (value: string | string[]): boolean => isString(value) || isArray(value) || isNull(value),\n};\n\ntype FaUploadImagesSlots = {\n\t/** @description 默认内容插槽 */\n\tdefault: never;\n};\n\nexport default defineComponent({\n\tname: \"FaUploadImages\",\n\tprops: faUploadImagesProps,\n\temits: faUploadImagesEmits,\n\tslots: makeSlots<FaUploadImagesSlots>(),\n\tsetup(props, { attrs, slots, emit, expose }) {\n\t\tconst {\n\t\t\tfileList,\n\t\t\tloading,\n\t\t\tformContext,\n\t\t\tmaxSizeMB,\n\t\t\thandleValue,\n\t\t\thandleHttpRequest,\n\t\t\thandleOnSuccess,\n\t\t\thandleOnError,\n\t\t\thandleOnExceed,\n\t\t\thandleOnUpload,\n\t\t} = useUpload(\"FaUploadImages\", \"图片\", props, emit, {\n\t\t\tmaxSize: props.maxSize,\n\t\t\tuploadApi: props.uploadApi,\n\t\t\tuploadUrl: props.uploadUrl,\n\t\t});\n\n\t\tconst disabled = computed(() => {\n\t\t\treturn props.disabled || formContext?.disabled;\n\t\t});\n\n\t\tconst state = reactive({\n\t\t\tuploadKey: `fa-upload-images__${stringUtil.generateRandomString(8)}`,\n\t\t\tpreview: false,\n\t\t\tpreviewIndex: -1,\n\t\t\tpreviewList: [],\n\t\t});\n\n\t\tconst uploadRef = ref<UploadInstance>();\n\n\t\tconst handleEdit = (): void => {\n\t\t\tconst uploadInputEl = document.querySelector(`.${state.uploadKey} .el-upload__input`);\n\t\t\tuploadInputEl && uploadInputEl.dispatchEvent(new MouseEvent(\"click\"));\n\t\t};\n\n\t\tconst handlePreview = (uploadFile: UploadFile): void => {\n\t\t\tstate.previewIndex = fileList.value.findIndex((f) => f.url === uploadFile.url);\n\t\t\tstate.previewList = fileList.value.map((m) => m.url);\n\t\t\tstate.preview = true;\n\t\t};\n\n\t\tconst handleRemove = (index: number): void => {\n\t\t\tfileList.value.splice(index, 1);\n\t\t\thandleValue();\n\t\t};\n\n\t\tconst handleBeforeUpload: UploadProps[\"beforeUpload\"] = (rawFile) => {\n\t\t\tif (!handleOnUpload(rawFile)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (props.beforeUpload) {\n\t\t\t\treturn props.beforeUpload(rawFile);\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\tconst elUploadProps = useProps(props, uploadProps, [\n\t\t\t\"fileList\",\n\t\t\t\"disabled\",\n\t\t\t\"httpRequest\",\n\t\t\t\"beforeUpload\",\n\t\t\t\"onExceed\",\n\t\t\t\"onSuccess\",\n\t\t\t\"onError\",\n\t\t]);\n\n\t\tuseRender(() => (\n\t\t\t<Fragment>\n\t\t\t\t<ElUpload\n\t\t\t\t\t{...elUploadProps.value}\n\t\t\t\t\tref={uploadRef}\n\t\t\t\t\tclass={[\"fa-upload-images\", state.uploadKey, { \"fa-upload-images__hidden-upload\": fileList.value.length >= props.limit }]}\n\t\t\t\t\tvLoading={loading.value}\n\t\t\t\t\tvModel:fileList={fileList.value}\n\t\t\t\t\tdisabled={disabled.value}\n\t\t\t\t\thttpRequest={handleHttpRequest}\n\t\t\t\t\tbeforeUpload={handleBeforeUpload}\n\t\t\t\t\tonExceed={handleOnExceed}\n\t\t\t\t\tonSuccess={handleOnSuccess}\n\t\t\t\t\tonError={handleOnError}\n\t\t\t\t>\n\t\t\t\t\t{{\n\t\t\t\t\t\tdefault: () =>\n\t\t\t\t\t\t\tfileList.value.length < props.limit && slots.default ? (\n\t\t\t\t\t\t\t\tslots.default()\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t<Plus />\n\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\ttip: () => <div class=\"el-upload__tip\">files with a size less than {maxSizeMB.toString()}MB</div>,\n\t\t\t\t\t\tfile: ({ file, index }: { file: UploadFile; index: number }) => (\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<img class=\"el-upload-list__item-thumbnail\" src={file.url} />\n\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-actions\">\n\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-preview\" onClick={() => handlePreview(file)} title=\"查看\">\n\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t<ZoomIn />\n\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t{!disabled.value && (\n\t\t\t\t\t\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={handleEdit} title=\"编辑\">\n\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Edit />\n\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"el-upload-list__item-icon\" onClick={() => handleRemove(index)} title=\"删除\">\n\t\t\t\t\t\t\t\t\t\t\t\t<ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t\t\t\t\t\t</ElIcon>\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</Fragment>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t),\n\t\t\t\t\t}}\n\t\t\t\t</ElUpload>\n\t\t\t\t{state.preview && (\n\t\t\t\t\t<ElImageViewer\n\t\t\t\t\t\tcloseOnPressEscape\n\t\t\t\t\t\thideOnClickModal\n\t\t\t\t\t\tteleported\n\t\t\t\t\t\tonClose={() => (state.preview = false)}\n\t\t\t\t\t\turlList={state.previewList}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</Fragment>\n\t\t));\n\n\t\treturn useExpose(expose, {\n\t\t\t/** @description 取消上传请求 */\n\t\t\tabort: computed(() => uploadRef.value?.abort),\n\t\t\t/** @description 手动上传文件列表 */\n\t\t\tsubmit: computed(() => uploadRef.value?.submit),\n\t\t\t/** @description 清空已上传的文件列表（该方法不支持在 before-upload 中调用） */\n\t\t\tclearFiles: computed(() => uploadRef.value?.clearFiles),\n\t\t\t/** @description 手动选择文件 */\n\t\t\thandleStart: computed(() => uploadRef.value?.handleStart),\n\t\t\t/** @description 手动移除文件。 file 和 rawFile 已被合并。 rawFile 将在 v2.2.0 中移除 */\n\t\t\thandleRemove: computed(() => uploadRef.value?.handleRemove),\n\t\t\t/** @description 加载状态 */\n\t\t\tloading,\n\t\t\t/** @description 文件集合 */\n\t\t\tfileList,\n\t\t\t/** @description 预览 */\n\t\t\tpreview: computed(() => state.preview),\n\t\t\t/** @description 预览集合 */\n\t\t\tpreviewList: computed(() => state.previewList),\n\t\t});\n\t},\n});\n"],"names":["faUploadImagesProps","uploadProps","accept","type","String","default","FaMimeType","Image","listType","definePropType","multiple","Boolean","limit","Number","modelValue","Array","maxSize","uploadApi","Function","uploadUrl","faUploadImagesEmits","value","isString","isArray","isNull","change","name","props","emits","slots","makeSlots","setup","attrs","emit","expose","fileList","loading","formContext","maxSizeMB","handleValue","handleHttpRequest","handleOnSuccess","handleOnError","handleOnExceed","handleOnUpload","useUpload","disabled","computed","state","reactive","uploadKey","stringUtil","generateRandomString","preview","previewIndex","previewList","uploadRef","ref","handleEdit","uploadInputEl","document","querySelector","dispatchEvent","MouseEvent","handlePreview","uploadFile","findIndex","f","url","map","m","handleRemove","index","splice","handleBeforeUpload","rawFile","beforeUpload","elUploadProps","useProps","useRender","_createVNode","_Fragment","_withDirectives","ElUpload","_mergeProps","length","$event","ElIcon","Plus","tip","_createTextVNode","toString","file","onClick","ZoomIn","Edit","Delete","_resolveDirective","ElImageViewer","onClose","useExpose","abort","submit","clearFiles","handleStart"],"mappings":"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"}