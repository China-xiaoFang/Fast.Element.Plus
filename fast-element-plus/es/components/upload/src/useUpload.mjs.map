{"version":3,"file":"useUpload.mjs","sources":["../../../../../packages/components/upload/src/useUpload.ts"],"sourcesContent":["import { inject, ref, watch } from \"vue\";\nimport { FastApp } from \"@fast-element-plus/settings\";\nimport { consoleError, consoleWarn, uploadUtil } from \"@fast-element-plus/utils\";\nimport { useVModel } from \"@vueuse/core\";\nimport { Decimal } from \"decimal.js\";\nimport type { UploadFile, UploadFiles, UploadProps, UploadRawFile, UploadRequestOptions, UploadUserFile } from \"element-plus\";\nimport { ElMessage, ElNotification, formContextKey, formItemContextKey, genFileId } from \"element-plus\";\nimport { isArray, isNumber, isString } from \"lodash-unified\";\n\nexport const useUpload = <T extends string | string[]>(\n\tcomponentName: string,\n\tfileTypeName: string,\n\tprops: UploadProps & {\n\t\tmodelValue: T;\n\t},\n\temit: ((event: \"update:fileList\", value: UploadUserFile[]) => void) &\n\t\t((event: \"update:modelValue\", value: T) => void) &\n\t\t((event: \"change\", value: T) => void),\n\tdata?: {\n\t\tmaxSize?: string | number;\n\t\tuploadUrl?: string;\n\t} // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\n) => {\n\tconst fileList = useVModel(props, \"fileList\", emit, { passive: true });\n\n\tconst loading = ref(false);\n\n\t// 获取 el-form 组件上下文\n\tconst formContext = inject(formContextKey, undefined);\n\t// 获取 el-form-item 组件上下文\n\tconst formItemContext = inject(formItemContextKey, undefined);\n\n\tconst mbNum = new Decimal(1024);\n\tconst maxSizeKB = new Decimal(isNumber(data?.maxSize) ? data?.maxSize : Number(data?.maxSize));\n\tconst maxSizeMB = maxSizeKB.div(mbNum);\n\n\tconst handleValue = (): void => {\n\t\tif (fileList.value.length > 0) {\n\t\t\tif (isString(props.modelValue)) {\n\t\t\t\temit(\"update:modelValue\", fileList.value[0].url as T);\n\t\t\t\temit(\"change\", fileList.value[0].url as T);\n\t\t\t} else {\n\t\t\t\tif (props.multiple) {\n\t\t\t\t\tconst value = fileList.value.map((m) => m.url);\n\t\t\t\t\temit(\"update:modelValue\", value as T);\n\t\t\t\t\temit(\"change\", value as T);\n\t\t\t\t} else {\n\t\t\t\t\temit(\"update:modelValue\", fileList.value[0].url as T);\n\t\t\t\t\temit(\"change\", fileList.value[0].url as T);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\temit(\"update:modelValue\", null);\n\t\t\temit(\"change\", null);\n\t\t}\n\t};\n\n\tconst handleHttpRequest = async (options: UploadRequestOptions): Promise<void> => {\n\t\tlet propsData;\n\t\tif (props.data) {\n\t\t\tpropsData = uploadUtil.getPropsData(options.file, props.data);\n\t\t}\n\t\tconst uploadUrl = data?.uploadUrl ?? FastApp.state.upload.url;\n\t\tif (!uploadUrl) {\n\t\t\tElMessage.error(`上传${fileTypeName}地址不能为空`);\n\t\t\tconsoleError(componentName, `上传${fileTypeName}地址 “uploadUrl” 不能为空`);\n\t\t\treturn;\n\t\t}\n\t\tloading.value = true;\n\t\ttry {\n\t\t\tconst fileUrl = await uploadUtil.uploadFile(uploadUrl, options.file, options.filename, propsData);\n\t\t\toptions.onSuccess(fileUrl);\n\t\t} finally {\n\t\t\tloading.value = false;\n\t\t}\n\t};\n\n\tconst handleOnSuccess = (fileUrl: string, uploadFile: UploadFile, uploadFiles: UploadFiles): void => {\n\t\tif (!fileUrl) return;\n\t\tif (!props.multiple && uploadFiles.length > 1) {\n\t\t\tuploadFiles.shift();\n\t\t}\n\t\tuploadFile.url = fileUrl;\n\t\thandleValue();\n\t\t// 调用 el-form 内部的校验方法（可自动校验）\n\t\tformItemContext?.prop && formContext?.validateField([formItemContext.prop as string]);\n\t\tElMessage.success(\"上传成功\");\n\t\tprops.onSuccess && props.onSuccess(fileUrl, uploadFile, uploadFiles);\n\t};\n\n\tconst handleOnError = (error: Error, uploadFile: UploadFile, uploadFiles: UploadFiles): void => {\n\t\tElNotification({\n\t\t\tmessage: `【${uploadFile.name}】${fileTypeName}上传失败，请您重新上传`,\n\t\t\ttype: \"error\",\n\t\t});\n\t\tprops.onError && props.onError(error, uploadFile, uploadFiles);\n\t};\n\n\tconst handleOnExceed = (files: File[], uploadFiles: UploadUserFile[]): void => {\n\t\tElMessage.warning(`最多只能上传 ${props.limit} 个${fileTypeName}，请移除后再进行上传`);\n\t\tprops.onExceed && props.onExceed(files, uploadFiles);\n\t};\n\n\tconst handleOnUpload = (file: UploadFile | UploadRawFile): boolean => {\n\t\tconst fileSizeKB = new Decimal(file.size).div(mbNum);\n\n\t\tif (fileSizeKB.greaterThan(maxSizeKB)) {\n\t\t\tconsoleWarn(componentName, `【${file.name}】${fileTypeName}上传大小不能超过 ${maxSizeMB.toString()}MB`);\n\t\t\tElMessage.warning(`【${file.name}】${fileTypeName}上传大小不能超过 ${maxSizeMB.toString()}MB`);\n\t\t\treturn false;\n\t\t}\n\n\t\tconst fileType = \"type\" in file ? file.type : file.raw.type;\n\n\t\tif (props.accept && props.accept.split(\",\").every((e) => e !== fileType)) {\n\t\t\tconst uploadFileNames = uploadUtil.detectFileType(props.accept);\n\t\t\tconsoleError(componentName, `只允许上传【${uploadFileNames}】格式的${fileTypeName}`);\n\t\t\tElMessage.error(`只允许上传【${uploadFileNames}】格式的${fileTypeName}`);\n\t\t\treturn false;\n\t\t}\n\t};\n\n\t/**\n\t * 监听 v-model 绑定数据\n\t */\n\twatch(\n\t\t() => props.modelValue,\n\t\t(newValue) => {\n\t\t\tif (newValue) {\n\t\t\t\tif (isArray(newValue)) {\n\t\t\t\t\tfileList.value = newValue.map((m) => {\n\t\t\t\t\t\tconst find = fileList.value.find((f) => f.url === m);\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tname: \"\",\n\t\t\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\t\t\tuid: find?.uid ?? genFileId(),\n\t\t\t\t\t\t\turl: m,\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst find = fileList.value.find((f) => f.url === newValue);\n\t\t\t\t\tfileList.value = [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: \"\",\n\t\t\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\t\t\tuid: find?.uid ?? genFileId(),\n\t\t\t\t\t\t\turl: newValue,\n\t\t\t\t\t\t},\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\timmediate: true,\n\t\t}\n\t);\n\n\treturn {\n\t\tfileList,\n\t\tloading,\n\t\tformContext,\n\t\tformItemContext,\n\t\tmaxSizeMB,\n\t\thandleValue,\n\t\thandleHttpRequest,\n\t\thandleOnSuccess,\n\t\thandleOnError,\n\t\thandleOnExceed,\n\t\thandleOnUpload,\n\t};\n};\n"],"names":[],"mappings":"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"}