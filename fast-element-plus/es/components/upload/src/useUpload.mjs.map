{"version":3,"file":"useUpload.mjs","sources":["../../../../../packages/components/upload/src/useUpload.ts"],"sourcesContent":["import { inject, onMounted, ref, watch } from \"vue\";\nimport { ElMessage, ElNotification, formContextKey, formItemContextKey, genFileId } from \"element-plus\";\nimport { consoleError, consoleWarn } from \"@fast-china/utils\";\nimport { useVModel } from \"@vueuse/core\";\nimport { Decimal } from \"decimal.js\";\nimport { isArray, isNumber, isString } from \"lodash-unified\";\nimport { uploadUtil } from \"../utils/upload\";\nimport type { UploadFile, UploadFiles, UploadProps, UploadRawFile, UploadRequestOptions, UploadUserFile } from \"element-plus\";\n\nexport const useUpload = <T extends string | string[]>(\n\tcomponentName: string,\n\tfileTypeName: string,\n\tprops: UploadProps & {\n\t\tmodelValue: T;\n\t},\n\temit: ((event: \"update:fileList\", value: UploadUserFile[]) => void) &\n\t\t((event: \"update:modelValue\", value: T) => void) &\n\t\t((event: \"change\", value: T) => void),\n\tdata?: {\n\t\tmaxSize?: string | number;\n\t\tuploadApi?: (formData: FormData) => Promise<string>;\n\t\tuploadUrl?: string;\n\t}\n\t// eslint-disable-next-line @typescript-eslint/explicit-function-return-type, @typescript-eslint/explicit-module-boundary-types\n) => {\n\tconst fileList = useVModel(props, \"fileList\", emit, { passive: true });\n\n\tconst loading = ref(false);\n\n\t// 获取 el-form 组件上下文\n\tconst formContext = inject(formContextKey, undefined);\n\t// 获取 el-form-item 组件上下文\n\tconst formItemContext = inject(formItemContextKey, undefined);\n\n\tconst mbNum = new Decimal(1024);\n\tconst maxSizeKB = new Decimal(isNumber(data?.maxSize) ? data?.maxSize : Number(data?.maxSize));\n\tconst maxSizeMB = maxSizeKB.div(mbNum);\n\n\tonMounted(() => {\n\t\tif (props.autoUpload && !data.uploadApi && !data.uploadUrl) {\n\t\t\tconsoleWarn(componentName, \"['uploadApi', 'uploadUrl'] 属性必须二选一。\");\n\t\t}\n\t});\n\n\tconst handleValue = (): void => {\n\t\tif (fileList.value.length > 0) {\n\t\t\tif (isString(props.modelValue)) {\n\t\t\t\temit(\"update:modelValue\", fileList.value[0].url as T);\n\t\t\t\temit(\"change\", fileList.value[0].url as T);\n\t\t\t} else {\n\t\t\t\tif (props.multiple) {\n\t\t\t\t\tconst value = fileList.value.map((m) => m.url);\n\t\t\t\t\temit(\"update:modelValue\", value as T);\n\t\t\t\t\temit(\"change\", value as T);\n\t\t\t\t} else {\n\t\t\t\t\temit(\"update:modelValue\", fileList.value[0].url as T);\n\t\t\t\t\temit(\"change\", fileList.value[0].url as T);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\temit(\"update:modelValue\", null);\n\t\t\temit(\"change\", null);\n\t\t}\n\t};\n\n\tconst handleHttpRequest = async (options: UploadRequestOptions): Promise<void> => {\n\t\tlet propsData;\n\t\tif (props.data) {\n\t\t\tpropsData = uploadUtil.getPropsData(options.file, props.data);\n\t\t}\n\t\tif (!data?.uploadApi && !data?.uploadUrl) {\n\t\t\tElMessage.error(`上传${fileTypeName}Api或地址不能为空`);\n\t\t\tconsoleError(componentName, `上传${fileTypeName}接口 “uploadApi” 或地址 “uploadUrl” 不能为空`);\n\t\t\treturn;\n\t\t}\n\t\tloading.value = true;\n\t\ttry {\n\t\t\tlet fileUrl: string;\n\t\t\tif (data.uploadApi) {\n\t\t\t\tfileUrl = await uploadUtil.uploadFileByApi(data.uploadApi, options.file, options.filename, propsData);\n\t\t\t} else {\n\t\t\t\tfileUrl = await uploadUtil.uploadFile(data.uploadUrl, options.file, options.filename, propsData);\n\t\t\t}\n\t\t\toptions.onSuccess(fileUrl);\n\t\t} finally {\n\t\t\tloading.value = false;\n\t\t}\n\t};\n\n\tconst handleOnSuccess = (fileUrl: string, uploadFile: UploadFile, uploadFiles: UploadFiles): void => {\n\t\tif (!fileUrl) return;\n\t\tif (!props.multiple && uploadFiles.length > 1) {\n\t\t\tuploadFiles.shift();\n\t\t}\n\t\tuploadFile.url = fileUrl;\n\t\thandleValue();\n\t\t// 调用 el-form 内部的校验方法（可自动校验）\n\t\tformItemContext?.prop && formContext?.validateField([formItemContext.prop as string]);\n\t\tElMessage.success(\"上传成功\");\n\t\tprops.onSuccess && props.onSuccess(fileUrl, uploadFile, uploadFiles);\n\t};\n\n\tconst handleOnError = (error: Error, uploadFile: UploadFile, uploadFiles: UploadFiles): void => {\n\t\tElNotification({\n\t\t\tmessage: `【${uploadFile.name}】${fileTypeName}上传失败，请您重新上传`,\n\t\t\ttype: \"error\",\n\t\t});\n\t\tprops.onError && props.onError(error, uploadFile, uploadFiles);\n\t};\n\n\tconst handleOnExceed = (files: File[], uploadFiles: UploadUserFile[]): void => {\n\t\tElMessage.warning(`最多只能上传 ${props.limit} 个${fileTypeName}，请移除后再进行上传`);\n\t\tprops.onExceed && props.onExceed(files, uploadFiles);\n\t};\n\n\tconst handleOnUpload = (file: UploadFile | UploadRawFile): boolean => {\n\t\tconst fileSizeKB = new Decimal(file.size).div(mbNum);\n\n\t\tif (fileSizeKB.greaterThan(maxSizeKB)) {\n\t\t\tconsoleWarn(componentName, `【${file.name}】${fileTypeName}上传大小不能超过 ${maxSizeMB.toString()}MB`);\n\t\t\tElMessage.warning(`【${file.name}】${fileTypeName}上传大小不能超过 ${maxSizeMB.toString()}MB`);\n\t\t\treturn false;\n\t\t}\n\n\t\tconst fileType = \"type\" in file ? file.type : file.raw.type;\n\n\t\tif (props.accept && props.accept.split(\",\").every((e) => e !== fileType)) {\n\t\t\tconst uploadFileNames = uploadUtil.detectFileType(props.accept);\n\t\t\tconsoleError(componentName, `只允许上传【${uploadFileNames}】格式的${fileTypeName}`);\n\t\t\tElMessage.error(`只允许上传【${uploadFileNames}】格式的${fileTypeName}`);\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\t/**\n\t * 监听 v-model 绑定数据\n\t */\n\twatch(\n\t\t() => props.modelValue,\n\t\t(newValue) => {\n\t\t\tif (newValue) {\n\t\t\t\tif (isArray(newValue)) {\n\t\t\t\t\tfileList.value = newValue.map((m) => {\n\t\t\t\t\t\tconst find = fileList.value.find((f) => f.url === m);\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tname: \"\",\n\t\t\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\t\t\tuid: find?.uid ?? genFileId(),\n\t\t\t\t\t\t\turl: m,\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst find = fileList.value.find((f) => f.url === newValue);\n\t\t\t\t\tfileList.value = [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: \"\",\n\t\t\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\t\t\tuid: find?.uid ?? genFileId(),\n\t\t\t\t\t\t\turl: newValue,\n\t\t\t\t\t\t},\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\timmediate: true,\n\t\t}\n\t);\n\n\treturn {\n\t\tfileList,\n\t\tloading,\n\t\tformContext,\n\t\tformItemContext,\n\t\tmaxSizeMB,\n\t\thandleValue,\n\t\thandleHttpRequest,\n\t\thandleOnSuccess,\n\t\thandleOnError,\n\t\thandleOnExceed,\n\t\thandleOnUpload,\n\t};\n};\n"],"names":["useUpload","componentName","fileTypeName","props","emit","data","fileList","useVModel","passive","loading","ref","formContext","inject","formContextKey","formItemContext","formItemContextKey","mbNum","Decimal","maxSizeKB","isNumber","maxSize","Number","maxSizeMB","div","onMounted","autoUpload","uploadApi","uploadUrl","consoleWarn","handleValue","value","length","isString","modelValue","url","multiple","map","m","watch","newValue","isArray","find","f","name","status","uid","genFileId","immediate","handleHttpRequest","async","options","propsData","uploadUtil","getPropsData","file","ElMessage","error","consoleError","fileUrl","uploadFileByApi","filename","uploadFile","onSuccess","handleOnSuccess","uploadFiles","shift","prop","validateField","success","handleOnError","ElNotification","message","type","onError","handleOnExceed","files","warning","limit","onExceed","handleOnUpload","size","greaterThan","toString","fileType","raw","accept","split","every","e","uploadFileNames","detectFileType"],"mappings":"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"}