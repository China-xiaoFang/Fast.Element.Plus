import{ref as e,inject as l,onMounted as a,watch as u}from"vue";import{formContextKey as i,formItemContextKey as t,ElMessage as r,ElNotification as o,genFileId as n}from"element-plus";import{consoleWarn as p,consoleError as d}from"@fast-china/utils";import{useVModel as s}from"@vueuse/core";import{Decimal as m}from"decimal.js";import{isNumber as c,isString as f,isArray as v}from"lodash-unified";import{uploadUtil as h}from"../utils/upload.mjs";const $=($,g,x,y,S)=>{const w=s(x,"fileList",y,{passive:!0}),A=e(!1),U=l(i,void 0),V=l(t,void 0),E=new m(1024),z=new m(c(S?.maxSize)?S?.maxSize:Number(S?.maxSize)),B=z.div(E);a(()=>{!x.autoUpload||S.uploadApi||S.uploadUrl||p($,"['uploadApi', 'uploadUrl'] 属性必须二选一。")});const F=()=>{if(w.value.length>0)if(f(x.modelValue))y("update:modelValue",w.value[0].url),y("change",w.value[0].url);else if(x.multiple){const e=w.value.map(e=>e.url);y("update:modelValue",e),y("change",e)}else y("update:modelValue",w.value[0].url),y("change",w.value[0].url);else y("update:modelValue",null),y("change",null)};return u(()=>x.modelValue,e=>{if(e)if(v(e))w.value=e.map(e=>{const l=w.value.find(l=>l.url===e);return{name:"",status:"success",uid:l?.uid??n(),url:e}});else{const l=w.value.find(l=>l.url===e);w.value=[{name:"",status:"success",uid:l?.uid??n(),url:e}]}},{immediate:!0}),{fileList:w,loading:A,formContext:U,formItemContext:V,maxSizeMB:B,handleValue:F,handleHttpRequest:async e=>{let l;if(x.data&&(l=h.getPropsData(e.file,x.data)),!S?.uploadApi&&!S?.uploadUrl)return r.error(`上传${g}Api或地址不能为空`),void d($,`上传${g}接口 “uploadApi” 或地址 “uploadUrl” 不能为空`);A.value=!0;try{let a;a=S.uploadApi?await h.uploadFileByApi(S.uploadApi,e.file,e.filename,l):await h.uploadFile(S.uploadUrl,e.file,e.filename,l),e.onSuccess(a)}finally{A.value=!1}},handleOnSuccess:(e,l,a)=>{e&&(!x.multiple&&a.length>1&&a.shift(),l.url=e,F(),V?.prop&&U?.validateField([V.prop]),r.success("上传成功"),x.onSuccess&&x.onSuccess(e,l,a))},handleOnError:(e,l,a)=>{o({message:`【${l.name}】${g}上传失败，请您重新上传`,type:"error"}),x.onError&&x.onError(e,l,a)},handleOnExceed:(e,l)=>{r.warning(`最多只能上传 ${x.limit} 个${g}，请移除后再进行上传`),x.onExceed&&x.onExceed(e,l)},handleOnUpload:e=>{if(new m(e.size).div(E).greaterThan(z))return p($,`【${e.name}】${g}上传大小不能超过 ${B.toString()}MB`),r.warning(`【${e.name}】${g}上传大小不能超过 ${B.toString()}MB`),!1;const l="type"in e?e.type:e.raw.type;if(x.accept&&x.accept.split(",").every(e=>e!==l)){const e=h.detectFileType(x.accept);return d($,`只允许上传【${e}】格式的${g}`),r.error(`只允许上传【${e}】格式的${g}`),!1}return!0}}};export{$ as useUpload};
//# sourceMappingURL=useUpload.mjs.map
