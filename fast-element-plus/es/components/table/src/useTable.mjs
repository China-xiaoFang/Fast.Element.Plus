import{ref as a,reactive as e,provide as t,computed as r,nextTick as o,watch as s}from"vue";import{useGlobalSize as n,dayjs as l}from"element-plus";import{consoleError as i,clickUtil as c,execFunction as p}from"@fast-china/utils";import{isFunction as h,isArray as g}from"lodash-unified";import{tableUtil as u}from"../utils/table.mjs";import{getTableDefaultSlots as m}from"./table.type.mjs";const d=/* @__PURE__ */Symbol("tableState"),b=/* @__PURE__ */Symbol("enumMap"),P=(P,f,C)=>{const w=n(),D=a(),S=a(),_=e(/* @__PURE__ */new Map);t(b,_);const y=e({loading:!1,loadingText:"加载中...",orgColumns:[],tableColumns:r(()=>y.orgColumns.filter(a=>a.prop&&!a.pureSearch)),searchColumns:r(()=>y.orgColumns.filter(a=>a.pureSearch||a.search).sort((a,e)=>a.search?.order-e.search?.order)),spanColumns:r(()=>[...y.orgColumns.filter(a=>a.spanProp).map(a=>({prop:a?.prop,spanProp:a?.spanProp})),...P.props.span?[{prop:"__table-index",spanProp:P.props.span},{prop:"__table-selection",spanProp:P.props.span},{prop:"__table-operation",spanProp:P.props.span}]:[]]),tableData:[],tableSpanData:r(()=>{if(y.spanColumns?.length>0&&y.tableData?.length>0){const a=[];y.spanColumns.forEach(e=>{a[e.prop]=new Array(y.tableData.length).fill(1,0,1).fill(0,1),a[`${e.prop}-index`]=0});for(let e=1;e<y.tableData.length;e++)y.spanColumns.forEach(t=>{y.tableData[e][t.spanProp]===y.tableData[e-1][t.spanProp]?a[t.prop][a[`${t.prop}-index`]]++:(a[`${t.prop}-index`]=e,a[t.prop][e]=1)});return a}return[]}),tablePagination:{pageIndex:1,pageSize:20,totalRows:0},initParam:{},searchParam:{},searchValueUpdate:"",searchForm:P.searchForm,selected:!1,selectedList:[],selectedListIds:r(()=>y.selectedList.map(a=>h(P.rowKey)?P.rowKey(a):a[P.rowKey])),indeterminateSelectedListIds:[],responseConfig:void 0,operationColumnWidth:r(()=>{const a=y.autoColumnWidth.find(a=>"__table-operation"===a.prop);if(a)return`${a.width}px`;switch(w.value){case"large":case"default":return"54px";case"small":return"42px";default:return"auto"}}),imagePreview:!1,previewList:[],tableWidth:void 0,tableHeight:void 0,autoColumnWidth:[]});t(d,y);const M=()=>{y.loading=!0,y.loadingText="加载中...",y.autoColumnWidth=[];const a=y.tableColumns.filter(a=>a.autoWidth);if(f?.operation&&a.push({prop:"__table-operation"}),a?.length>0){const e="default"===w.value?25:17;o(()=>{const t=document.querySelector(`.fa-table__${P.tableKey}`);t&&a.forEach(a=>{const r=t.querySelector(`.__fa-table__auto-width-column__cell-header__${a?.prop}`),o=t.querySelectorAll(`.__fa-table__auto-width-column__cell__${a?.prop}`);let s=0;r&&(s=Math.ceil(r.scrollWidth)+e,a?.sortable&&(s+=24)),o.forEach(a=>{const t=Math.ceil(a.scrollWidth)+e;t>s&&(s=t)});const n=y.autoColumnWidth.find(e=>e.prop===a?.prop);n?n.width=Math.max(n.width,s):y.autoColumnWidth.push({prop:a?.prop,width:s})})})}y.loading=!1},x=a=>{if(P.treeData){const e=[];return a.forEach(a=>{const t=a[P.props.children];g(t)?t.forEach(t=>e.push({...a,...t})):e.push({...a,...t||{}})}),e}return a},k=()=>{const a={...y.searchParam,...P.pagination?y.tablePagination:{}};return delete a.totalRows,a},Y=async()=>{if(y.loading=!0,y.loadingText="加载中...",P.requestApi){const e=k();C("refresh",e);let t=[];try{const a=await P.requestApi(e);if(P.dataCallback&&P.dataCallback(a),P.pagination){const e=a;t=e.rows,Object.assign(y.tablePagination,{pageIndex:e.pageIndex,pageSize:e.pageSize,totalRows:e.totalRows})}else t=a,Object.assign(y.tablePagination,{pageIndex:1,pageSize:0,totalRows:t.length});y.tableData=x(t)}catch(a){i("FaTable",a),y.tableData=[]}finally{y.loading=!1}}else{C("refresh",{searchValue:y.searchParam.searchValue});let a=x(P.data);if(a=a.filter(a=>!y.searchParam.searchValue||y.tableColumns.some(e=>a[e.prop]?.toString()?.toLowerCase().includes(y.searchParam.searchValue?.toLowerCase()))),y.searchParam.sortList?.length>0&&(a=a.sort(u.arrayDynamicSort(y.searchParam.sortList))),P.pagination){Object.assign(y.tablePagination,{totalRows:a.length});const e=(y.tablePagination.pageIndex-1)*y.tablePagination.pageSize,t=e+y.tablePagination.pageSize;y.tableData=a.slice(e,t)}else y.tableData=a,Object.assign(y.tablePagination,{pageIndex:1,pageSize:0,totalRows:a.length});y.loading=!1}M()},z=()=>{let a=P.columns?P.columns:[];a.forEach(a=>{(a.pureSearch||a.search)&&(a.search.key??=a.prop,a.search.label??=a.label,a.search.defaultValue&&(y.searchParam[a.search.key]=a.search.defaultValue))}),a=a.sort((a,e)=>a?.order-e?.order),y.orgColumns=u.flatColumns(a,_)},F=()=>{if(P.hideSearchTime)y.searchParam.searchTimeList=void 0;else{const a=/* @__PURE__ */new Date,e=/* @__PURE__ */new Date;if(P.futureSearchTime)switch(P.dataSearchRange){case"Past1D":a.setDate(a.getDate()+1);break;case"Past3D":a.setDate(a.getDate()+3);break;case"Past1W":a.setDate(a.getDate()+7);break;case"Past1M":a.setMonth(a.getMonth()+1);break;case"Past3M":a.setMonth(a.getMonth()+3);break;case"Past6M":a.setMonth(a.getMonth()+6);break;case"Past1Y":a.setFullYear(a.getFullYear()+1);break;case"Past3Y":a.setFullYear(a.getFullYear()+3)}else switch(P.dataSearchRange){case"Past1D":e.setDate(e.getDate()-1);break;case"Past3D":e.setDate(e.getDate()-3);break;case"Past1W":e.setDate(e.getDate()-7);break;case"Past1M":e.setMonth(e.getMonth()-1);break;case"Past3M":e.setMonth(e.getMonth()-3);break;case"Past6M":e.setMonth(e.getMonth()-6);break;case"Past1Y":e.setFullYear(e.getFullYear()-1);break;case"Past3Y":e.setFullYear(e.getFullYear()-3)}y.searchParam.searchTimeList=[l(e).format("YYYY-MM-DD 00:00:00"),l(a).format("YYYY-MM-DD 23:59:59")]}},R=async()=>{y.tablePagination.pageIndex=1,(()=>{const a={};for(const e in y.searchParam)y.searchParam[e]||!1===y.searchParam[e]||0===y.searchParam[e]?a[e]=y.searchParam[e]:y.searchParam[e]||delete y.searchParam[e];Object.assign(y.searchParam,a)})(),await Y()},W=async()=>{y.orgColumns=[],y.autoColumnWidth=[],y.tableData=[],await c.debounceAsync(async()=>{z(),await R()},300)};return s(()=>P.tableKey,async()=>{await W()}),s(()=>P.searchForm,a=>{y.searchForm=a}),{_globalSize:w,state:y,elementRef:D,tableRef:S,handleTableColumnAutoWidth:M,getRequestParam:k,loadTableColumns:z,handleSizeChange:a=>{y.tablePagination.pageIndex=1,y.tablePagination.pageSize=a,C("sizeChange",a),C("paginationChange",1,a),Y()},handlePaginationChange:a=>{y.tablePagination.pageIndex=a,C("sizeChange",y.tablePagination.pageSize),C("paginationChange",a,y.tablePagination.pageSize),Y()},defaultSearchTime:F,tableSearch:R,tableReset:async()=>{y.tablePagination.pageIndex=1,y.searchParam={},F(),Object.keys(y.initParam??{}).forEach(a=>{y.searchParam[a]=y.initParam[a]}),C("reset",y.searchParam),await Y()},doRender:W,doLoading:(a,e="加载中...")=>{y.loading=!0,y.loadingText=e,p(a).then().catch(a=>{i("FaTable",a)}).finally(()=>{y.loading=!1})},handleCustomCellClick:(a,{row:e,column:t,$index:r})=>{C("customCellClick",a,{row:e,column:t,$index:r,...m(y)})}}};export{b as enumMapKey,d as tableStateKey,P as useTable};
//# sourceMappingURL=useTable.mjs.map
