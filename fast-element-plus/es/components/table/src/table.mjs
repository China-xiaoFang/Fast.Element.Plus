import{isVNode as e,defineComponent as a,ref as t,onMounted as l,watch as n,watchEffect as o,onActivated as i,computed as r,createVNode as s,withDirectives as c,Fragment as d,mergeProps as u,createTextVNode as m,resolveDirective as h}from"vue";import{useSizeProp as g,ElInput as p,ElDatePicker as f,ElButton as b,ElDropdown as C,ElDropdownMenu as w,ElTable as _,ElTableColumn as y,ElIcon as S,ElPagination as v,ElImageViewer as x}from"element-plus";import{Search as P,Refresh as L,Eleme as I,Setting as F,More as B}from"@element-plus/icons-vue";import{NotData as R}from"@fast-element-plus/icons-vue";import{definePropType as O,stringUtil as T,consoleWarn as k,clickUtil as D,useProps as N,useRender as E,dateUtil as j,useExpose as M,makeSlots as z}from"@fast-china/utils";import{isString as K,isObject as A,isNumber as H,isBoolean as $,isArray as V,isNull as W,isFunction as U,pick as Y,omit as q}from"lodash-unified";import{getTableDefaultSlots as G}from"./table.type.mjs";import J from"./tableColumn.mjs";import Q from"./tableColumnSettingDialog.mjs";import X from"./tablePagination.mjs";import Z from"./tableSearchForm.mjs";import{useTable as ee}from"./useTable.mjs";const ae={data:{type:Array,default:()=>[]},size:g,width:[String,Number],height:[String,Number],maxHeight:[String,Number],fit:{type:Boolean,default:!0},stripe:Boolean,border:Boolean,rowKey:[String,Function],showHeader:{type:Boolean,default:!0},showSummary:Boolean,sumText:String,summaryMethod:Function,rowClassName:[String,Function],rowStyle:[Object,Function],cellClassName:[String,Function],cellStyle:[Object,Function],headerRowClassName:[String,Function],headerRowStyle:[Object,Function],headerCellClassName:[String,Function],headerCellStyle:[Object,Function],highlightCurrentRow:Boolean,currentRowKey:[String,Number],emptyText:String,expandRowKeys:Array,defaultExpandAll:Boolean,defaultSort:Object,tooltipEffect:String,tooltipOptions:Object,spanMethod:Function,selectOnIndeterminate:{type:Boolean,default:!0},indent:{type:Number,default:16},treeProps:{type:Object,default:()=>({hasChildren:"hasChildren",children:"children",checkStrictly:!1})},lazy:Boolean,load:Function,style:{type:Object,default:()=>({})},className:{type:String,default:""},tableLayout:{type:String,default:"fixed"},scrollbarAlwaysOn:Boolean,flexible:Boolean,showOverflowTooltip:[Boolean,Object],scrollbarTabindex:{type:[Number,String],default:void 0}},te={...ae,border:{type:Boolean,default:!0},highlightCurrentRow:{type:Boolean,default:!0},rowKey:{type:[String,Function],default:"id"},spanMethod:{type:Function,validator:()=>(k("FaTable","'spanMethod' 属性，组件已经封装，外部使用会失效。"),!1)},tableKey:{type:String,default:()=>T.generateRandomString(8)},data:{type:O(Array),default:()=>[]},requestApi:{type:O(Function)},dataCallback:{type:O(Function)},initParam:O([String,Number,Object]),columns:{type:O([Array,Boolean]),default:()=>[]},columnsChange:{type:O(Function)},searchFormCols:{type:O([String,Number,Object]),default:()=>({xs:3,sm:3,md:4,lg:5,xl:6})},searchForm:{type:Boolean,default:!0},headerCard:{type:Boolean,default:!0},refreshBtn:{type:Boolean,default:!0},searchBtn:{type:Boolean,default:!0},columnSettingBtn:{type:Boolean,default:!0},toolBtn:{type:Boolean,default:!0},hideSearchTime:Boolean,dataSearchRange:{type:O(String),default:"Past3D"},pagination:{type:Boolean,default:!0},hideImage:Boolean,single:Boolean,rowClickSelection:Boolean,treeData:Boolean,props:{type:O(Object),default:()=>({span:void 0,children:"children"})},autoRefresh:{type:Boolean,default:!0},rowSelectable:Function},le={select:(e,a)=>V(e)&&A(a),selectAll:e=>V(e),selectionChange:e=>V(e),cellMouseEnter:(e,a,t,l)=>A(e)&&A(a)&&t instanceof HTMLTableCellElement&&l instanceof Event,cellMouseLeave:(e,a,t,l)=>A(e)&&A(a)&&t instanceof HTMLTableCellElement&&l instanceof Event,cellClick:(e,a,t,l)=>A(e)&&A(a)&&t instanceof HTMLTableCellElement&&l instanceof Event,cellDblclick:(e,a,t,l)=>A(e)&&A(a)&&t instanceof HTMLTableCellElement&&l instanceof Event,cellContextmenu:(e,a,t,l)=>A(e)&&A(a)&&t instanceof HTMLTableCellElement&&l instanceof Event,rowClick:(e,a,t)=>A(e)&&A(a)&&t instanceof Event,rowContextmenu:(e,a,t)=>A(e)&&A(a)&&t instanceof Event,rowDblclick:(e,a,t)=>A(e)&&A(a)&&t instanceof Event,headerClick:(e,a)=>A(e)&&a instanceof Event,headerContextmenu:(e,a)=>A(e)&&a instanceof Event,sortChange:e=>A(e),filterChange:e=>K(e)||H(e)||$(e)||A(e),currentChange:(e,a)=>A(e)&&(W(a)||A(a)),headerDragend:(e,a,t,l)=>H(e)&&H(a)&&A(t)&&l instanceof MouseEvent,expandChange:(e,a)=>A(e)&&($(a)||V(a)),refresh:e=>A(e),reset:e=>A(e),sizeChange:e=>H(e),paginationChange:(e,a)=>H(e)&&H(a),customCellClick:(e,{row:a,column:t,$index:l})=>K(e)&&A(a)&&A(t)&&H(l)},ne=/* @__PURE__ */a({name:"FaTable",props:te,emits:le,slots:z(),setup(a,{attrs:g,slots:O,emit:T,expose:k}){const{_globalSize:z,state:A,elementRef:H,tableRef:$,handleTableColumnAutoWidth:V,loadTableColumns:W,handleSizeChange:te,handlePaginationChange:le,defaultSearchTime:ne,tableSearch:oe,tableReset:ie,doRender:re,doLoading:se,handleCustomCellClick:ce}=ee(a,O,T),de=t();let ue=0;const me=e=>{if(0===e&&(ue=0),A.spanColumns?.length>0){return 0===Number(A.tableSpanData["__table-index"][e])?ue+(A.tablePagination.pageIndex-1)*A.tablePagination.pageSize+1:(ue++,ue+(A.tablePagination.pageIndex-1)*A.tablePagination.pageSize)}return e+(A.tablePagination.pageIndex-1)*A.tablePagination.pageSize+1},he=(e,t)=>{a.single&&($.value.clearSelection(),e.length>0&&t&&$.value.toggleRowSelection(t)),T("select",e,t)},ge=e=>{a.single&&(A.selected?A.tableData.length>0&&($.value.clearSelection(),$.value.toggleRowSelection(A.tableData[0])):$.value.clearSelection()),T("selectAll",e)},pe=e=>{0===e.length?A.selected=!1:A.selected=!0,a.single&&e.length>0?A.selectedList=[e[e.length-1]]:A.selectedList=e,A.indeterminateSelectedListIds=A.indeterminateSelectedListIds.filter(e=>A.selectedListIds.some(a=>a===e)),T("selectionChange",A.selectedList)},fe=({column:e,prop:t,order:l})=>{e.multiOrder?"descending"===e.multiOrder?e.multiOrder="ascending":e.multiOrder=null:e.multiOrder="descending",A.searchParam.sortList=[.../* @__PURE__ */new Set([...a.initParam?.sortList??[],...A.searchParam?.sortList??[]])];const n=A.orgColumns.find(e=>e.prop===t),o=n.sortableField??n.prop??n.property,i=A.searchParam.sortList.findIndex(e=>e.enField===o);e.multiOrder?-1===i?A.searchParam.sortList.push({enField:o,cnField:n.label,mode:e.multiOrder}):A.searchParam.sortList[i].mode=e.multiOrder:A.searchParam.sortList.splice(i,1),0===A.searchParam.sortList.length&&delete A.searchParam.sortList,T("sortChange",{column:e,prop:t,order:e.multiOrder}),oe()},be=(e,t)=>{e&&(a.rowClickSelection&&(a.single&&t&&$.value.toggleRowSelection(t),$.value.toggleRowSelection(e)),T("currentChange",e,t))},Ce=({row:e,column:t,rowIndex:l,columnIndex:n})=>{let o=null;if("selection"===t.type){const t=U(a.rowKey)?a.rowKey(e):e[a.rowKey];A.indeterminateSelectedListIds.some(e=>e===t)&&(o="fa-table__selection-column__indeterminate")}const i=A.tableColumns.find(e=>e.prop===t.property);if(i?.dataDeleteField&&e&&!0===e[i.dataDeleteField]&&(o?o+=" fa-table__data-delete-column":o="fa-table__data-delete-column"),"submitInfo"===i?.type&&(o?o+=" fa-table__line-height-normal-column":o="fa-table__line-height-normal-column"),"date"!==i?.type&&"time"!==i?.type&&"dateTime"!==i?.type||i?.dateFix&&(o?o+=" fa-table__line-height-normal-column":o="fa-table__line-height-normal-column"),a.cellClassName){let i=null;return i=K(a.cellClassName)?a.cellClassName:a.cellClassName({row:e,column:t,rowIndex:l,columnIndex:n}),i?o?`${o} ${i}`:i:o}return o},we=({row:e,column:t,rowIndex:l,columnIndex:n})=>(t.order=t.multiOrder,a.headerCellClassName?U(a.headerCellClassName)?a.headerCellClassName({row:e,column:t,rowIndex:l,columnIndex:n}):a.headerCellClassName:null),_e=({row:e,column:a,rowIndex:t,columnIndex:l})=>{const n=a.property??a.columnKey;if(-1!==A.spanColumns.findIndex(e=>e.prop===n)){const e=Number(A.tableSpanData[n][t]);return e>0?{rowspan:e,colspan:1}:{rowspan:0,colspan:0}}return{rowspan:1,colspan:1}},ye=async(e,a,t,l)=>{A.orgColumns.forEach(a=>{t.property===a.prop&&(a.width=e,a.smallWidth=e)}),T("headerDragend",e,a,t,l),await D.debounceAsync(de.value.change,500)},Se=e=>{A.previewList=[e],A.imagePreview=!0};l(async()=>{A.initParam=a.initParam,W(),ne(),Object.keys(a.initParam??{}).forEach(e=>{A.searchParam[e]=a.initParam[e]}),await oe(),n(()=>a.initParam,()=>{Object.keys(a.initParam??{}).forEach(e=>{A.searchParam[e]=a.initParam[e]})},{deep:!0}),n(()=>a.data,async()=>{!a.requestApi&&a.autoRefresh&&await oe()},{deep:!0,immediate:!0}),o(async()=>{const e=H.value;if(e){const a=new ResizeObserver(e=>{for(const a of e){const{width:e,height:t}=a.contentRect;A.tableWidth=e,A.tableHeight=t}D.debounceAsync(async()=>{await V()},100)});return a.observe(e),()=>{a.disconnect()}}})}),i(async()=>{await V()});const ve=r(()=>A.searchColumns.filter(e=>e.search.slot).map(e=>e.search.slot)),xe=r(()=>A.tableColumns.filter(e=>e.slot).map(e=>e.slot)),Pe=["multiOrder","columnID","order","sortableField","disabledSortable","spanProp","pureSearch","search"],Le=N(a,ae,["data","spanMethod","headerCellClassName","cellClassName"]);return E(()=>s("div",{ref:H,class:["fa-table",`fa-table-${z.value}`,`fa-table__${a.tableKey??"notFound"}`,{fa__click__disabled:A.loading}],style:{"--fa-table-width":""+(A.tableWidth?`${A.tableWidth}px`:""),"--fa-table-height":""+(A.tableHeight?`${A.tableHeight}px`:"")}},[s(Z,{show:a.searchForm&&A.searchForm,cols:a.searchFormCols,search:oe,reset:ie},Y(O,ve.value)),O.topHeader&&s("div",{class:"el-card fa-table__header"},[O.topHeader({search:oe,...G(A)})]),s("div",{class:"el-card fa-table__main"},[a.headerCard&&s("div",{class:"fa-table__main-header"},[s("div",{class:"fa-table__main-header-left"},[O.header&&O.header({search:oe,...G(A)})]),s("div",{class:"fa-table__main-header-right"},[a.toolBtn&&s(d,null,[s("div",{class:"fa-table__main-header-right__div-search"},[s(p,{class:"fa-table__main-header-right__input-search",disabled:A.loading,prefixIcon:P,placeholder:"关键字搜索",modelValue:A.searchParam.searchValue,modelModifiers:{trim:!0},"onUpdate:modelValue":e=>A.searchParam.searchValue=e,clearable:!0,onCompositionupdate:e=>{A.searchValueUpdate=e.data},onCompositionend:e=>{A.searchValueUpdate=""},onChange:()=>oe()},null),s("div",{class:"fa-table__main-header-right__div-search__hidden"},[A.searchParam.searchValue,A.searchValueUpdate])]),a.requestApi&&!a.hideSearchTime&&s(f,{class:"fa-table__main-header-right__data-search",popperClass:"fa-table__main-header-right__data-search__popper",disabled:A.loading,type:"daterange",modelValue:A.searchParam.searchTimeList,"onUpdate:modelValue":e=>A.searchParam.searchTimeList=e,defaultTime:j.getDefaultTime(),shortcuts:j.getShortcuts(),valueFormat:"YYYY-MM-DD HH:mm:ss",disabledDate:j.getDisabledDate,clearable:!1,teleported:!1,unlinkPanels:!0,onChange:()=>oe()},null),O.toolButton&&O.toolButton({search:oe,...G(A)}),a.refreshBtn&&s(b,{loading:A.loading,loadingIcon:I,title:"刷新",circle:!0,icon:L,onClick:()=>oe()},null),a.searchBtn&&A.searchColumns.length>0&&s(b,{loading:A.loading,loadingIcon:I,title:A.searchForm?"隐藏搜索栏":"显示搜索栏",circle:!0,icon:P,onClick:()=>A.searchForm=!A.searchForm},null),a.columnSettingBtn&&!a.columns&&s(b,{loading:A.loading,loadingIcon:I,title:"表格列配置",circle:!0,icon:F,onClick:()=>de.value.open()},null),O.toolButtonAdv&&s(C,{title:"高级操作",trigger:"click"},{default:()=>s(b,{loading:A.loading,loadingIcon:I,circle:!0,icon:B},null),dropdown:()=>{let a;return s(w,null,"function"==typeof(t=a=O.toolButtonAdv({search:oe,...G(A)}))||"[object Object]"===Object.prototype.toString.call(t)&&!e(t)?a:{default:()=>[a]});var t}})])])]),c(s(_,u(Le.value,{ref:$,"element-loading-text":A.loadingText,data:A.tableData,spanMethod:_e,headerCellClassName:we,cellClassName:Ce,onSelectionChange:pe,onSortChange:fe,onSelect:he,onSelectAll:ge,onCurrentChange:be,onHeaderDragend:ye,onCellMouseEnter:(e,a,t,l)=>T("cellMouseEnter",e,a,t,l),onCellMouseLeave:(e,a,t,l)=>T("cellMouseLeave",e,a,t,l),onCellClick:(e,a,t,l)=>T("cellClick",e,a,t,l),onCellDblclick:(e,a,t,l)=>T("cellDblclick",e,a,t,l),onCellContextmenu:(e,a,t,l)=>T("cellContextmenu",e,a,t,l),onRowClick:(e,a,t)=>T("rowClick",e,a,t),onRowContextmenu:(e,a,t)=>T("rowContextmenu",e,a,t),onRowDblclick:(e,a,t)=>T("rowDblclick",e,a,t),onHeaderClick:(e,a)=>T("headerClick",e,a),onHeaderContextmenu:(e,a)=>T("headerContextmenu",e,a),onFilterChange:e=>T("filterChange",e),onExpandChange:(e,a)=>T("expandChange",e,a)}),{append:()=>O.append&&O.append(),empty:()=>s("div",{class:"fa-table__empty"},[O.empty?O.empty():s(d,null,[s(S,null,{default:()=>[s(R,null,null)]}),s("div",null,[m("暂无数据")])])]),default:()=>s(d,null,[s(y,{className:"fa-table__index-column",type:"index",fixed:"left",width:A.tablePagination.pageIndex*A.tablePagination.pageSize>=100?A.tablePagination.pageIndex*A.tablePagination.pageSize>=1e3?50:40:30,align:"center",index:me,showOverflowTooltip:!1,resizable:!1,columnKey:"__table-index"},null),s(y,{className:"fa-table__selection-column",type:"selection",fixed:"left",width:35,align:"center",reserveSelection:!0,showOverflowTooltip:!1,resizable:!1,columnKey:"__table-selection",selectable:a.rowSelectable},null),O.operation&&s(y,{fixed:"right",width:A.operationColumnWidth,headerAlign:"center",align:"left",showOverflowTooltip:!1,className:"fa-table__operation-column",resizable:!1,columnKey:"__table-operation"},{header:()=>s("div",{class:"fa-table__auto-width-column__cell-header __fa-table__auto-width-column__cell-header____table-operation"},[s("span",null,[m("操作")])]),default:({row:e,column:a,$index:t})=>s("div",{class:"fa-table__auto-width-column__cell __fa-table__auto-width-column__cell____table-operation"},[O.operation({row:e,column:a,$index:t,search:oe,...G(A)})])}),0===A.tableColumns?.length?O.default&&O.default():A.tableColumns.map(e=>e.show&&("expand"===e.type?s(y,u(e,{width:35,fixed:e.fixed??"left",resizable:!1}),{default:({row:a,column:t,$index:l})=>s(d,null,[e.render&&e.render({row:a,column:t,$index:l,...G(A)}),e.slot&&O[e.slot]&&O[e.slot]({row:a,column:t,$index:l,...G(A)})])}):e.prop&&s(J,u(q(e,Pe),{resizable:!0,onImagePreview:Se,onCustomCellClick:ce}),Y(O,xe.value))))])}),[[h("loading"),A.loading]]),s("div",{class:"fa-table__main-footer"},[s("div",{class:"fa-table__main-footer__left"},[O.footer&&O.footer({search:oe,...G(A)})]),O.pagination?O.pagination({pageIndex:A.tablePagination.pageIndex,pageSize:A.tablePagination.pageSize,totalRows:A.tablePagination.totalRows,handleSizeChange:te,handlePaginationChange:le}):s(d,null,[a.pagination?s(X,{onSizeChange:te,onCurrentChange:le},null):s(v,{class:"fa-table-pagination",size:"small",layout:"total",total:A.tableData.length},null)])])]),A.imagePreview&&s(x,{closeOnPressEscape:!0,hideOnClickModal:!0,teleported:!0,onClose:()=>A.imagePreview=!1,urlList:A.previewList},null),s(Q,{ref:de,save:a.columnsChange},null)])),M(k,{clearSelection:r(()=>$.value?.clearSelection),getSelectionRows:r(()=>$.value?.getSelectionRows),toggleRowSelection:r(()=>$.value?.toggleRowSelection),toggleAllSelection:r(()=>$.value?.toggleAllSelection),toggleRowExpansion:r(()=>$.value?.toggleRowExpansion),setCurrentRow:r(()=>$.value?.setCurrentRow),clearSort:r(()=>$.value?.clearSort),clearFilter:r(()=>$.value?.clearFilter),doLayout:r(()=>$.value?.doLayout),sort:r(()=>$.value?.sort),scrollTo:r(()=>$.value?.scrollTo),setScrollTop:r(()=>$.value?.setScrollTop),setScrollLeft:r(()=>$.value?.setScrollLeft),columns:r(()=>$.value?.columns),updateKeyChildren:r(()=>$.value?.updateKeyChildren),loading:r(()=>A.loading),tableData:r(()=>A.tableData),tablePagination:r(()=>A.tablePagination),searchParam:r(()=>A.searchParam),selected:r(()=>A.selected),selectedList:r(()=>A.selectedList),selectedListIds:r(()=>A.selectedListIds),indeterminateSelectedListIds:r(()=>A.indeterminateSelectedListIds),tableWidth:r(()=>A.tableWidth),tableHeight:r(()=>A.tableHeight),toggleRowIndeterminateSelection:(e,t)=>{const l=U(a.rowKey)?a.rowKey(e):e[a.rowKey],n=A.tableData.find(e=>U(a.rowKey)?a.rowKey(e):e[a.rowKey]===l);if(!0===t)A.indeterminateSelectedListIds.some(e=>e===l)||A.indeterminateSelectedListIds.push(l),$.value.toggleRowSelection(n,!0);else if(!1===t){const e=A.indeterminateSelectedListIds.findIndex(e=>e===l);e>=0&&A.indeterminateSelectedListIds.splice(e,1),$.value.toggleRowSelection(n,!1)}else{const e=A.indeterminateSelectedListIds.findIndex(e=>e===l);e>=0?A.indeterminateSelectedListIds.splice(e,1):A.indeterminateSelectedListIds.push(l),$.value.toggleRowSelection(n)}},refresh:oe,reset:ie,doRender:re,doLoading:se})}});export{ne as default,le as faTableEmits,te as faTableProps,ae as tableProps};
//# sourceMappingURL=table.mjs.map
